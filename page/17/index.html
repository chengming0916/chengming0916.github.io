<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"chengming0916.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Chemmy&#39;s Blog">
<meta property="og:url" content="http://chengming0916.github.io/page/17/index.html">
<meta property="og:site_name" content="Chemmy&#39;s Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Chemmy">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chengming0916.github.io/page/17/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/17/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Chemmy's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>





  <script src="/js/third-party/pace.js" defer></script>


  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Chemmy's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">chengming0916@outlook.com</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Chemmy"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Chemmy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">186</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">174</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chengming0916" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chengming0916" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/chengming0916@outlook.com" title="E-Mail → chengming0916@outlook.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2017/02/12/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/WPF/WPF%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/12/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/WPF/WPF%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C/" class="post-title-link" itemprop="url">WPF 数据校验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-02-12 09:24:49" itemprop="dateCreated datePublished" datetime="2017-02-12T09:24:49+08:00">2017-02-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/" itemprop="url" rel="index"><span itemprop="name">DotNet</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/WPF/" itemprop="url" rel="index"><span itemprop="name">WPF</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>只要是有表单存在，那么就有可能有对数据的校验需求。如：判断是否为整数、判断电子邮件格式等等。</p>
<p>WPF采用一种全新的方式 - Binding，来实现前台显示与后台数据进行交互，当然数据校验方式也不一样了。</p>
<p>本专题全面介绍一下WPF中4种Validate方法，帮助你了解如何在WPF中对binding的数据进行校验，并处理错误显示。</p>
<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>正常情况下，只要是绑定过程中出现异常或者在converter中出现异常，都会造成绑定失败。</p>
<p>但是WPF不会出现任何异常，只会显示一片空白（当然有些Converter中的异常会造成程序崩溃）。</p>
<p>这是因为默认情况下，Binding.ValidatesOnException为false，所以WPF忽视了这些绑定错误。</p>
<p>但是如果我们把Binding.ValidatesOnException为true，那么WPF会对错误做出以下反应：</p>
<ol>
<li>设置绑定元素的附加属性 Validation.HasError为true（如TextBox，如果Text被绑定，并出现错误）。</li>
<li>创建一个包含错误详细信息（如抛出的Exception对象）的ValidationError对象。</li>
<li>将上面产生的对象添加到绑定对象的Validation.Errors附加属性当中。</li>
<li>如果Binding.NotifyOnValidationError是true，那么绑定元素的附加属性中的Validation.Error附加事件将被触发。（这是一个冒泡事件）</li>
</ol>
<p>我们的Binding对象，维护着一个ValidationRule的集合，当设置ValidatesOnException为true时，</p>
<p>默认会添加一个ExceptionValidationRule到这个集合当中。</p>
<p>PS：对于绑定的校验只在Binding.Mode 为TwoWay和OneWayToSource才有效，</p>
<p>即当需要从target控件将值传到source属性时，很容易理解，当你的值不需要被别人使用时，就很可能校验也没必要。</p>
<h2 id="二、四种实现方法"><a href="#二、四种实现方法" class="headerlink" title="二、四种实现方法"></a>二、四种实现方法</h2><h4 id="1、在Setter方法中进行判断"><a href="#1、在Setter方法中进行判断" class="headerlink" title="1、在Setter方法中进行判断"></a>1、在Setter方法中进行判断</h4><p>直接在Setter方法中，对value进行校验，如果不符合规则，那么就抛出异常。然后修改XAML不忽视异常。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonValidateInSetter</span> : <span class="title">ObservableObject</span></span><br><span class="line">    &#123; <span class="keyword">private</span> <span class="built_in">string</span> name; <span class="keyword">private</span> <span class="built_in">int</span> age; <span class="keyword">public</span> <span class="built_in">string</span> Name</span><br><span class="line">        &#123; <span class="keyword">get</span>   &#123;  <span class="keyword">return</span> <span class="keyword">this</span>.name;   &#125; <span class="keyword">set</span> &#123; <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(<span class="keyword">value</span>))</span><br><span class="line">                &#123; <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Name cannot be empty!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">if</span> (<span class="keyword">value</span>.Length &lt; <span class="number">4</span>)</span><br><span class="line">                &#123; <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Name must have more than 4 char!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">this</span>.name = <span class="keyword">value</span>; <span class="keyword">this</span>.OnPropertyChanged(() =&gt; <span class="keyword">this</span>.Name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">public</span> <span class="built_in">int</span> Age</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.age;  &#125; <span class="keyword">set</span> &#123; <span class="keyword">if</span> (<span class="keyword">value</span> &lt; <span class="number">18</span>)</span><br><span class="line">                &#123; <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;You must be an adult!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">this</span>.age = <span class="keyword">value</span>; <span class="keyword">this</span>.OnPropertyChanged(() =&gt; <span class="keyword">this</span>.Age);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&lt;Grid</span> <span class="string">DataContext=&quot;&#123;Binding</span> <span class="string">PersonValidateInSetter&#125;&quot;&gt;</span></span><br><span class="line">               <span class="string">&lt;Grid.RowDefinitions&gt;</span></span><br><span class="line">                   <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                   <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">               <span class="string">&lt;/Grid.RowDefinitions&gt;</span></span><br><span class="line">               <span class="string">&lt;Grid.ColumnDefinitions&gt;</span></span><br><span class="line">                   <span class="string">&lt;ColumnDefinition</span> <span class="string">Width\=&quot;Auto&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                   <span class="string">&lt;ColumnDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">               <span class="string">&lt;/Grid.ColumnDefinitions&gt;</span></span><br><span class="line">               <span class="string">&lt;TextBlock</span> <span class="string">Text=&quot;Name:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">               <span class="string">&lt;TextBox</span> <span class="string">Grid.Column=&quot;1&quot;</span> <span class="string">Margin=&quot;1&quot;</span> <span class="string">Text=&quot;&#123;Binding</span> <span class="string">Name,</span></span><br><span class="line">                                       <span class="string">ValidatesOnExceptions=True,</span></span><br><span class="line">                                       <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">               <span class="string">&lt;TextBlock</span> <span class="string">Grid.Row=&quot;1&quot;</span> <span class="string">Text=&quot;Age:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">               <span class="string">&lt;TextBox</span> <span class="string">Grid.Row=&quot;1&quot;</span> <span class="string">Grid.Column=&quot;1&quot;</span> <span class="string">Margin=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Age,</span></span><br><span class="line">                                       <span class="string">ValidatesOnExceptions=True,</span></span><br><span class="line">                                       <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">           <span class="string">&lt;/Grid&gt;</span></span><br><span class="line">           </span><br></pre></td></tr></table></figure>

<p>当输入的值，在setter方法中校验时出现错误，就会出现一个红色的错误框。</p>
<p>关键代码：<code>ValidatesOnExceptions=True, UpdateSourceTrigger=PropertyChanged</code>。</p>
<p><strong>注意</strong>: 这种方式有一个BUG，首次加载时不会对默认数据进行检验。</p>
<h4 id="2、继承IDataErrorInfo接口"><a href="#2、继承IDataErrorInfo接口" class="headerlink" title="2、继承IDataErrorInfo接口"></a>2、继承IDataErrorInfo接口</h4><p>使Model对象继承IDataErrorInfo接口，并实现一个索引进行校验。如果索引返回空表示没有错误，如果返回不为空，</p>
<p>表示有错误。另外一个Erro属性，但是在WPF中没有被用到。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonDerivedFromIDataErrorInfo</span> : <span class="title">ObservableObject</span>, <span class="title">IDataErrorInfo</span></span><br><span class="line">    &#123; <span class="keyword">private</span> <span class="built_in">string</span> name; <span class="keyword">private</span> <span class="built_in">int</span> age; <span class="keyword">public</span> <span class="built_in">string</span> Name</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">            &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.name = <span class="keyword">value</span>; <span class="keyword">this</span>.OnPropertyChanged(() =&gt; <span class="keyword">this</span>.Name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">public</span> <span class="built_in">int</span> Age</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">            &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.age = <span class="keyword">value</span>; <span class="keyword">this</span>.OnPropertyChanged(() =&gt; <span class="keyword">this</span>.Age);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// never called by WPF</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Error</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">public</span> <span class="built_in">string</span> <span class="keyword">this</span>\[<span class="built_in">string</span> propertyName\]</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">switch</span> (propertyName)</span><br><span class="line">                &#123; <span class="keyword">case</span> <span class="string">&quot;Name&quot;</span>: <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(<span class="keyword">this</span>.Name))</span><br><span class="line">                        &#123; <span class="keyword">return</span> <span class="string">&quot;Name cannot be empty!&quot;</span>;</span><br><span class="line">                        &#125; <span class="keyword">if</span> (<span class="keyword">this</span>.Name.Length &lt; <span class="number">4</span>)</span><br><span class="line">                        &#123; <span class="keyword">return</span> <span class="string">&quot;Name must have more than 4 char!&quot;</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>; <span class="keyword">case</span> <span class="string">&quot;Age&quot;</span>: <span class="keyword">if</span> (<span class="keyword">this</span>.Age &lt; <span class="number">18</span>)</span><br><span class="line">                        &#123; <span class="keyword">return</span> <span class="string">&quot;You must be an adult!&quot;</span>;</span><br><span class="line">                        &#125; <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;Grid</span>  <span class="string">DataContext=&quot;&#123;Binding</span> <span class="string">PersonDerivedFromIDataErrorInfo&#125;&quot;\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.RowDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.RowDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">Width\=&quot;Auto&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Text\=&quot;Name:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Name,</span></span><br><span class="line">                                        <span class="string">NotifyOnValidationError=True,</span></span><br><span class="line">                                        <span class="string">ValidatesOnDataErrors=True,</span></span><br><span class="line">                                        <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Text\=&quot;Age:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Age,</span></span><br><span class="line">                                        <span class="string">NotifyOnValidationError=True,</span></span><br><span class="line">                                        <span class="string">ValidatesOnDataErrors=True,</span></span><br><span class="line">                                        <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>PS：这种方式，没有了第一种方法的BUG，但是相对很麻烦，既需要继承接口，又需要添加一个索引，如果遗留代码，那么这种方式就不太好。</p>
<h4 id="3、自定义校验规则"><a href="#3、自定义校验规则" class="headerlink" title="3、自定义校验规则"></a>3、自定义校验规则</h4><p>一个数据对象或许不能包含一个应用要求的所有不同验证规则，但是通过自定义验证规则就可以解决这个问题。</p>
<p>在需要的地方，添加我们创建的规则，并进行检测。</p>
<p>通过继承<code>ValidationRule</code>抽象类，并实现<code>Validate</code>方法，并添加到绑定元素的<code>Binding.ValidationRules</code>中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MinAgeValidation</span> : <span class="title">ValidationRule</span></span><br><span class="line">    &#123; <span class="keyword">public</span> <span class="built_in">int</span> MinAge &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> ValidationResult <span class="title">Validate</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span>, CultureInfo cultureInfo</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ValidationResult result \= <span class="literal">null</span>; <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="literal">null</span>)</span><br><span class="line">            &#123; <span class="built_in">int</span> age; <span class="keyword">if</span> (<span class="built_in">int</span>.TryParse(<span class="keyword">value</span>.ToString(), <span class="keyword">out</span> age))</span><br><span class="line">                &#123; <span class="keyword">if</span> (age &lt; <span class="keyword">this</span>.MinAge)</span><br><span class="line">                    &#123;</span><br><span class="line">                        result \= <span class="keyword">new</span> ValidationResult(<span class="literal">false</span>, <span class="string">&quot;Age must large than &quot;</span> + <span class="keyword">this</span>.MinAge.ToString(CultureInfo.InvariantCulture));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result \= <span class="keyword">new</span> ValidationResult(<span class="literal">false</span>, <span class="string">&quot;Age must be a number!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result \= <span class="keyword">new</span> ValidationResult(<span class="literal">false</span>, <span class="string">&quot;Age must not be null!&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">return</span> <span class="keyword">new</span> ValidationResult(<span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&lt;Grid\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.RowDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.RowDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">Width\=&quot;Auto&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Text\=&quot;Name:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Name&#125;&quot;\&gt;</span></span><br><span class="line">                <span class="string">&lt;/TextBox\&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Text\=&quot;Age:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;\&gt;</span></span><br><span class="line">                    <span class="string">&lt;TextBox.Text\&gt;</span></span><br><span class="line">                        <span class="string">&lt;Binding</span> <span class="string">Path\=&quot;Age&quot;</span> <span class="string">UpdateSourceTrigger\=&quot;PropertyChanged&quot;</span> <span class="string">ValidatesOnDataErrors\=&quot;True&quot;\&gt;</span></span><br><span class="line">                            <span class="string">&lt;Binding.ValidationRules\&gt;</span></span><br><span class="line">                                <span class="string">&lt;validations:MinAgeValidation</span> <span class="string">MinAge\=&quot;18&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                            <span class="string">&lt;/Binding.ValidationRules\&gt;</span></span><br><span class="line">                        <span class="string">&lt;/Binding\&gt;</span></span><br><span class="line">                    <span class="string">&lt;/TextBox.Text\&gt;</span></span><br><span class="line">                <span class="string">&lt;/TextBox\&gt;</span></span><br><span class="line">            <span class="string">&lt;/Grid\&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种方式，也会有第一种方法的BUG，暂时还不知道如何解决，但是这个能够灵活的实现校验，并且能传参数。</p>
<p>效果图：<br>![[WPF数据校验&#x2F;IMG-20250804110742687.png]]</p>
<h4 id="4、使用数据注解-特性方式"><a href="#4、使用数据注解-特性方式" class="headerlink" title="4、使用数据注解(特性方式)"></a>4、使用数据注解(特性方式)</h4><p>在System.ComponentModel.DataAnnotaions命名空间中定义了很多特性，</p>
<p>它们可以被放置在属性前面，显示验证的具体需要。放置了这些特性之后，</p>
<p>属性中的Setter方法就可以使用Validator静态类了，来用于验证数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonUseDataAnnotation</span> : <span class="title">ObservableObject</span></span><br><span class="line">    &#123; <span class="keyword">private</span> <span class="built_in">int</span> age; <span class="keyword">private</span> <span class="built_in">string</span> name;</span><br><span class="line">        \[Range(<span class="number">18</span>, <span class="number">120</span>, ErrorMessage = <span class="string">&quot;Age must be a positive integer&quot;</span>)\] <span class="keyword">public</span> <span class="built_in">int</span> Age</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">            &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.ValidateProperty(<span class="keyword">value</span>, <span class="string">&quot;Age&quot;</span>); <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.age, <span class="keyword">value</span>, () =&gt; <span class="keyword">this</span>.Age);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        \[Required(ErrorMessage \= <span class="string">&quot;A name is required&quot;</span>)\]</span><br><span class="line">        \[StringLength(<span class="number">100</span>, MinimumLength = <span class="number">3</span>, ErrorMessage = <span class="string">&quot;Name must have at least 3 characters&quot;</span>)\] <span class="keyword">public</span> <span class="built_in">string</span> Name</span><br><span class="line">        &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">            &#125; <span class="keyword">set</span> &#123; <span class="keyword">this</span>.ValidateProperty(<span class="keyword">value</span>, <span class="string">&quot;Name&quot;</span>); <span class="keyword">this</span>.SetProperty(<span class="keyword">ref</span> <span class="keyword">this</span>.name, <span class="keyword">value</span>, () =&gt; <span class="keyword">this</span>.Name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">ValidateProperty</span>&lt;<span class="title">T</span>&gt;(<span class="params">T <span class="keyword">value</span>, <span class="built_in">string</span> propertyName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Validator.ValidateProperty(<span class="keyword">value</span>,                <span class="keyword">new</span> ValidationContext(<span class="keyword">this</span>, <span class="literal">null</span>, <span class="literal">null</span>) &#123; MemberName = propertyName &#125;); &#125; ___&#125;___</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&lt;Grid\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.RowDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;RowDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.RowDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">Width\=&quot;Auto&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;ColumnDefinition</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid.ColumnDefinitions\&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Text\=&quot;Name:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Name,</span></span><br><span class="line">                                        <span class="string">ValidatesOnExceptions=True,</span></span><br><span class="line">                                        <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBlock</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Text\=&quot;Age:&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;TextBox</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">Age,</span></span><br><span class="line">                                        <span class="string">ValidatesOnExceptions=True,</span></span><br><span class="line">                                        <span class="string">UpdateSourceTrigger=PropertyChanged&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">            <span class="string">&lt;/Grid\&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用特性的方式，能够很自由的使用自定义的规则，而且在.Net4.5中新增了很多特性，可以很方便的对数据进行校验。</p>
<p>例如：EmailAddress, Phone, and Url等。</p>
<h2 id="三、自定义错误显示模板"><a href="#三、自定义错误显示模板" class="headerlink" title="三、自定义错误显示模板"></a>三、自定义错误显示模板</h2><p>在上面的例子中，我们可以看到当出现验证不正确时，绑定控件会被一圈红色错误线包裹住。</p>
<p>这种方式一般不能够正确的展示出，错误的原因等信息，所以有可能需要自己的错误显示方式。</p>
<p>前面，我们已经讲过了。当在检测过程中，出现错误时，WPF会把错误信息封装为一个ValidationError对象，</p>
<p>并添加到Validation.Errors中，所以我们可以取出错误详细信息，并显示出来。</p>
<h4 id="1、为控件创建ErrorTemplate"><a href="#1、为控件创建ErrorTemplate" class="headerlink" title="1、为控件创建ErrorTemplate"></a>1、为控件创建ErrorTemplate</h4><p>下面就是一个简单的例子，每次都把错误信息以红色展示在空间上面。这里的AdornedElementPlaceholder相当于</p>
<p>控件的占位符，表示控件的真实位置。这个例子是在书上直接拿过来的，只能做基本展示用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&lt;ControlTemplate</span> <span class="string">x:Key\=&quot;ErrorTemplate&quot;\&gt;</span></span><br><span class="line">            <span class="string">&lt;Border</span> <span class="string">BorderBrush\=&quot;Red&quot;</span> <span class="string">BorderThickness\=&quot;2&quot;\&gt;</span></span><br><span class="line">                <span class="string">&lt;Grid\&gt;</span></span><br><span class="line">                    <span class="string">&lt;AdornedElementPlaceholder</span> <span class="string">x:Name\=&quot;\_el&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                    <span class="string">&lt;TextBlock</span> <span class="string">Margin\=&quot;0,0,6,0&quot;</span> <span class="string">HorizontalAlignment\=&quot;Right&quot;</span> <span class="string">VerticalAlignment\=&quot;Center&quot;</span> <span class="string">Foreground\=&quot;Red&quot;</span> <span class="string">Text\=&quot;&#123;Binding</span> <span class="string">\[0\].ErrorContent&#125;&quot;</span> <span class="string">/&gt;</span></span><br><span class="line">                <span class="string">&lt;/Grid\&gt;</span></span><br><span class="line">            <span class="string">&lt;/Border\&gt;</span></span><br><span class="line">        <span class="string">&lt;/ControlTemplate\&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&lt;TextBox</span> <span class="string">x:Name\=&quot;AgeTextBox&quot;</span> <span class="string">Grid.Row\=&quot;1&quot;</span> <span class="string">Grid.Column\=&quot;1&quot;</span> <span class="string">Margin\=&quot;1&quot;</span> <span class="string">Validation.ErrorTemplate\=&quot;&#123;StaticResource</span> <span class="string">ErrorTemplate&#125;&quot;</span> <span class="string">\&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用方式非常简单，将上面的模板作为逻辑资源加入项目中，然后像上面一样引用即可。</p>
<p>效果图：</p>
<p>![[WPF数据校验&#x2F;IMG-20250804110742879.png]]</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2017/02/10/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/02/10/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/Docker%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Docker使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-02-10 00:00:00" itemprop="dateCreated datePublished" datetime="2017-02-10T00:00:00+08:00">2017-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">容器技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.open-open.com/lib/view/open1423703640748.html">非常详细的 Docker 学习笔记 - Docker - 服务器软件 - 深度开源 (open-open.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zydev/p/5803461.html">Docker-创建和分享应用（3） - 头痛不头痛 - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wsscy2004/article/details/25878363">常用docker命令，及一些坑_dockerfile 2&gt;&amp;1-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang__jiayu/article/details/42611469">Docker常用命令_docker -i -t -v-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://phuker.github.io/posts/docker-commands.html">Docker 常用命令 - Phuker’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/101509.htm">详解Docker 容器基础系统镜像打包_docker_脚本之家 (jb51.net)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hjh00/article/details/51437815">一种docker基础镜像制作方法_docker 从iso制作镜像-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://linux.cn/article-5427-1.html">系统运维|两种方式创建你自己的 Docker 基本映像 (linux.cn)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2017/01/14/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E6%9C%80%E5%85%A8%E7%9A%84Windows%20Azure%E5%AD%A6%E4%B9%A0%E6%95%99%E7%A8%8B%E6%B1%87%E6%80%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/14/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E6%9C%80%E5%85%A8%E7%9A%84Windows%20Azure%E5%AD%A6%E4%B9%A0%E6%95%99%E7%A8%8B%E6%B1%87%E6%80%BB/" class="post-title-link" itemprop="url">最全的Windows Azure学习教程汇总</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-01-14 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-14T00:00:00+08:00">2017-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/" itemprop="url" rel="index"><span itemprop="name">DotNet</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Windows Azure 是微软基于云计算的操作系统，能够为开发者提供一个平台，帮助开发可运行在云服务器、数据中心、Web 和 PC 上的应用程序。</p>
<p>Azure 是一种灵活和支持互操作的平台，能够将处于云端的开发者个人能力，同微软全球数据中心网络托管的服务，比如存储、计算和网络基础设施服务，紧密结合起来。帮助开发者在“云端”和“客户端”同时部署应用，使得企业与用户都能共享资源。</p>
<p>本文整理了丰富的 Windows Azure 学习资源，帮助开发者能全面地学习 Windows Azure 知识，并将 Windows Azure 运用在项目和实际工作中。  </p>
<p>通过本系列博客，先来了解一下 Windows Azure 平台的基本知识。Windows Azure，正如同桌面操作系统 Windows 和服务器操作系统 Windows Server 一样，是一个云端的操作系统。开发人员可以使用同一套技术：.NET（包括 Silverlight），或者 Win32，同时针对桌面，服务器，以及云，开发程序，而不需要针对某个平台学习专门的技术。Visual Studio 和 Expression Studio 为开发人员提供了强大的工具支持。</p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/05/windows-azure-94/">Windows Azure平台简介(一)：定位与产品结构</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/05/windows-azurewindows-azure/">Windows Azure平台简介(二)：Windows Azure</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/05/windows-azureappfabric/">Windows Azure平台简介(三)：AppFabric</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/05/windows-azuresql-azure/">Windows Azure平台简介(四)：SQL Azure以及其他服务</a></p>
<p>在开始本教学之前，请确保你从 <a target="_blank" rel="noopener" href="http://msdn.microsoft.com/zh-cn/windowsazure/cc974146">Windows Azure 平台下载</a>下载并安装了最新的 Windows Azure 开发工具。本教学使用 Visual Studio 2010 作为开发工具。</p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/09/windows-azure-webrole/">Windows Azure入门教学系列 (一)：创建第一个WebRole程序</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/18/windows-azure-web-role/">Windows Azure入门教学系列 (二)：部署第一个Web Role程序</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/02/22/windows-azure-worker-role/">Windows Azure入门教学系列 (三)：创建第一个Worker Role程序</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/03/07/windows-azure-blob-storage/">Windows Azure入门教学系列 (四)：使用Blob Storage</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/03/08/windows-azure-queue-storage/">Windows Azure入门教学系列 (五)：使用Queue Storage</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/03/11/windows-azure-table-storage/">Windows Azure入门教学系列 (六)：使用Table Storage</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/03/19/windows-azure-rest-apistorage-service/">Windows Azure入门教学系列 (七)：使用REST API访问Storage Service</a></p>
<p><a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/azchina/2010/04/12/windows-azure-windows-azure-drive/">Windows Azure入门教学系列 (八)：使用Windows Azure Drive</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ghostbear/article/details/20532753">Azure学习笔记：Web Site（1）</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ghostbear/article/details/20533315">Azure学习笔记：Service Bus（2）</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ghostbear/article/details/20533339">Azure学习笔记：Storage（3）</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/ghostbear/article/details/20533419">Azure学习笔记：Cloud Service（4）</a></p>
<p>Azure Storage 是微软 Azure 云提供的云端存储解决方案，当前支持的存储类型有 Blob、Queue、File 和 Table。</p>
<p><img src="https://images2015.cnblogs.com/blog/139239/201611/139239-20161108110807749-165409149.png"></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/Azure_Blob_Storage.html">Azure Blob Storage 基本用法 – Azure Storage 之 Blob</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/powertoolsteam/p/Azure%20Queue%20Storage%20%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95%20--%20Azure%20Storage%20%E4%B9%8B%20Queue">Azure Queue Storage 基本用法 – Azure Storage 之 Queue</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/Azure_File_Storage.html">Azure File Storage 基本用法 – Azure Storage 之 File</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/5707033.html">Azure Table storage 基本用法 – Azure Storage 之 Table</a></p>
<p>Windows Azure Storage 支持三重冗余的。保存在 Azure Storage 的内容，会在同一个数据中心保留有3个副本。这样的好处显而易见：当数据中心发生一般性故障的时候，比如磁盘损坏，机架服务器损坏等，用户保存在 Azure Storage 的数据不会丢失。每次对于 Storage 的写操作，都会对三个副本进行同步写操作，等到在副本操作完毕之后，才会返回执行成功给客户端。</p>
<p>Windows Azure 提供了三种不同类型的存储服务(这里的存储是非关系型数据，比如图片、文档等文件)，用来提供给 Windows Azure 上运行的应用程序存储数据使用。依据不同的存储格式会有不同的限制，因为这些存储服务都是以分散式巨量存储（Distributed Mass Storage）为核心概念所设计出来的，为了要达成快速在分散式存储空间中存储与管理数据（还包含高可用度的赘余存储管理），微软有在数据的存储上做一些限制。</p>
<p>微软还提供了 REST API 来方便用户操作 Storage Service。</p>
<p>（1）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/18/2325567.html">Windows Azure Storage Service存储服务</a></p>
<p>（2）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/19/2327651.html">Windows Azure Storage Service存储服务之Blob详解(上)</a></p>
<p>（3）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/20/2328004.html">Windows Azure Storage Service存储服务之Blob详解(中)</a></p>
<p>（4）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/20/2553501.html">Windows Azure Storage Service存储服务之Blob Share Access Signature</a></p>
<p>（5）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/21/2328638.html">Windows Azure Drive</a></p>
<p>（6）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3406259.html">Windows Azure Storage之Table</a></p>
<p>（7）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/23/2328878.html">使用工具管理Windows Azure Storage</a></p>
<p>（8）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/06/07/2540896.html">Windows Azure 上的托管服务CDN (上)</a></p>
<p>（9）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/06/08/2541682.html">Windows Azure 上的托管服务CDN (中) Blob Service</a></p>
<p>（10）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/06/11/2542076.html">Windows Azure 上的托管服务CDN (下) Hosted Service</a>、</p>
<p>（11）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/06/19/2555286.html">计算你存储的Blob的大小</a></p>
<p>（12）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2013/05/23/3093667.html">本地冗余存储 vs 地理冗余存储 (上)</a></p>
<p>（13）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2013/05/23/3094803.html">本地冗余存储 vs 地理冗余存储 (下)</a></p>
<p>（14）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3211183.html">使用Azure Blob的PutBlock方法，实现文件的分块、离线上传</a></p>
<p>（15）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3398818.html">使用WCF服务，将本地图片上传至Azure Storage (上) 服务器端代码</a></p>
<p>（16）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3401591.html">使用WCF服务，将本地图片上传至Azure Storage (上) 客户端代码</a></p>
<p>（17）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3778854.html">Azure Storage读取访问地域冗余(Read Access – Geo Redundant Storage, RA-GRS)</a></p>
<p>（18）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3788615.html">使用HTML5 Portal的Azure CDN服务</a></p>
<p>（19）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4403539.html">再谈Azure Block Blob和Page Blob</a></p>
<p>（20）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4441388.html">使用Azure File实现共享文件夹</a></p>
<p>（21）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4486392.html">使用AzCopy工具，加快Azure Storage传输速度</a></p>
<p>（22）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4872080.html">Azure Storage如何支持多级目录</a></p>
<p>（23）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5179832.html">计算Azure VHD实际使用容量</a></p>
<p>PowerShell 是管理 Azure 的最好方式之一，通过使用 PowerShell 脚本可以把很多的工作自动化。比如对于 Azure 上的虚拟机，可以设置定时关机操作，并在适当的时间把它开机，这样就能减少虚拟机的运行时间，同时也能为节能减排做出贡献。</p>
<p>（1）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4001540.html">PowerShell入门</a></p>
<p>（2）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4001943.html">修改Azure订阅名称</a></p>
<p>（3）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4001632.html">上传证书</a></p>
<p>（4）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4001907.html">使用PowerShell管理多个订阅</a></p>
<p>（5）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4016287.html">使用Azure PowerShell创建简单的Azure虚拟机和Linux虚拟机</a></p>
<p>（6）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4018913.html">设置单个Virtual Machine Endpoint</a></p>
<p>（7）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4174346.html">使用CSV文件批量设置Virtual Machine Endpoint</a></p>
<p>（8）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4378472.html">使用PowerShell设置Azure负载均衡器规则</a></p>
<p>（9）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4427990.html">使用PowerShell导出订阅下所有的Azure VM的Public IP和Private IP</a></p>
<p>（10）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4802038.html">使用PowerShell导出订阅下所有的Azure VM和Cloud Service的高可用情况</a></p>
<p>（11）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5381726.html">使用自定义虚拟机镜像模板，创建Azure虚拟机并绑定公网IP(VIP)和内网IP(DIP)</a></p>
<p>（12）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/6000824.html">通过Azure PowerShell创建SSH登录的Linux VM</a></p>
<p>SQL Azure 是微软基于 Microsoft SQL Server Denali，也就是 SQL Server 2012 构建的云端关系型数据库服务。SQL Azure 是 SQL Server 的一个大子集，能够实现 SQL Server 的绝大部分功能，并且将它们作为云端的服务来扩展。SQL Azure Database 提供内置的高精准、可用性、功效与其他功能。</p>
<p>（1）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/31/2332370.html">入门</a></p>
<p>（2）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/31/2332746.html">SQL Azure vs SQL Server</a></p>
<p>（3）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/31/2332845.html">创建一个SQL Azure 服务器</a></p>
<p>（4）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/31/2332859.html">创建一个SQL Azure数据库</a></p>
<p>（5）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/01/31/2332915.html">使用SQL Server Management Studio连接SQL Azure</a></p>
<p>（6）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/02/27/2367773.html">使用Project Houston管理SQL Azure</a></p>
<p>（7）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/02/01/2334403.html">在SQL Azure Database中执行的T-SQL</a></p>
<p>（8）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/02/02/2334949.html">使用Visual Studio 2010开发应用连接SQL Azure云端数据库</a></p>
<p>（9）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/02/06/2338122.html">把本地的SQL Server数据库迁移到SQL Azure云数据库上</a></p>
<p>（10）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/03/26/2417757.html">SQL Azure Data Sync数据同步功能(上)</a></p>
<p>（11）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2012/03/26/2417907.html">SQL Azure Data Sync数据同步功能(下)</a></p>
<p>（12）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/archive/2013/03/28/2986097.html">使用新Portal 创建 SQL Azure Database</a></p>
<p>（13）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3439856.html">Azure的两种关系型数据库服务：SQL Azure与SQL Server VM的不同</a></p>
<p>（14）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3662486.html">将云端SQL Azure中的数据库备份到本地SQL Server</a></p>
<p>（15）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/3778087.html">SQL Azure 新的规格</a></p>
<p>（16）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/4986231.html">创建PaaS SQL Azure V12数据库</a></p>
<p>（17）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5481911.html">SQL Azure V12 - 跨数据中心标准地域复制(Standard Geo-Replication)</a></p>
<p>（18）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5552502.html">使用External Table实现垮库查询</a></p>
<p>（19）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5822962.html">Stretch Database 概览</a></p>
<p>（20）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5824869.html">使用SQL Server 2016 Upgrade Advisor</a></p>
<p>（21）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5826310.html">将整张表都迁移到Azure Stretch Database里</a></p>
<p>（22）<a target="_blank" rel="noopener" href="http://www.cnblogs.com/threestone/p/5826450.html">迁移部分数据到Azure Stretch Database</a></p>
<p>1. 《Windows Azure 实战》全面深入，完整覆盖 Windows Azure 所有关键技术和理论，详细讲解云计算开发流程、云服务架构（可用性、可靠性和高性能）、云设备整合、系统整合，以及云计算项目的管理。<br>注重实战，68个精心策划的针对特定实际应用场景的真实案例，详细呈现案例的设计思路和完整实现步骤。</p>
<p><img src="https://images2015.cnblogs.com/blog/139239/201611/139239-20161108134142889-1790002180.jpg"></p>
<p>2. 《Windows Azure 从入门到精通》介绍了如何构建和管理云端的可扩展应用，一次一个知识点，同时辅之以适当的练习，可帮助读者轻松掌握基本的编程技能，掌握 Windows Azure 云计算平台的核心服务和特性，是一本理想的入门教程。</p>
<p><strong><img src="https://images2015.cnblogs.com/blog/139239/201611/139239-20161108134407405-1273791227.jpg"></strong></p>
<p>3. 《云计算与Azure平台实战》解决了从本地转移到基于云的应用程序时，可能面临的各种问题；展示了如何将 ASP.NET 身份验证和角色管理用应用于 Azure Web 角色；揭示了迁移到 Windows Azure 时把计算服务卸载到一个或多个 WorkerWeb 角色的益处；讲解如何为共享 Azure 表选择最合适的 PartionKey 和 RowKey 值的组合；探讨了改善 Azure 表的可扩展性和性能的方法。</p>
<p><img src="https://images2015.cnblogs.com/blog/139239/201611/139239-20161108135006545-720283508.jpg"></p>
<p>4. 《走进云计算:Windows Azure实战手记》介绍了你必须学会的微软云开发技术，介绍目前最火爆的云计算，深入剖析微软最新的云开发平台，涵盖 Windows Azure 环境、存储服务、SQL Azure 数据库与 App Fabric 服务平台 Step by Step 递进教学，初学者可按部就班地学习云应用的开发技术。</p>
<p><img src="https://images2015.cnblogs.com/blog/139239/201611/139239-20161108135448327-262312994.jpg"></p>
<p><strong>相关阅读：</strong></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/Azure_Blob_Storage.html">Azure Blob Storage 基本用法 – Azure Storage 之 Blob</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/Azure_Queue_Storage.html">Azure Queue Storage 基本用法 – Azure Storage 之 Queue</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/Azure_File_Storage.html">Azure File Storage 基本用法 – Azure Storage 之 File</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/powertoolsteam/p/5707033.html">Azure Table storage 基本用法 – Azure Storage 之 Table</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/" class="post-title-link" itemprop="url">分布式ID生成方法生成演变</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-01-07 00:00:00" itemprop="dateCreated datePublished" datetime="2017-01-07T00:00:00+08:00">2017-01-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/" itemprop="url" rel="index"><span itemprop="name">DotNet</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>一、需求缘起</strong></p>
<p>几乎所有的业务系统，都有生成一个记录标识的需求，例如：</p>
<p>（1）消息标识：message-id</p>
<p>（2）订单标识：order-id</p>
<p>（3）帖子标识：tiezi-id</p>
<p>这个记录标识往往就是数据库中的<strong>唯一主键</strong>，数据库上会建立聚集索引（cluster index），即在物理存储上以这个字段排序。</p>
<p>这个记录标识上的查询，往往又有分页或者排序的业务需求，例如：</p>
<p>（1）拉取最新的一页消息：selectmessage-id&#x2F; order by time&#x2F; limit 100</p>
<p>（2）拉取最新的一页订单：selectorder-id&#x2F; order by time&#x2F; limit 100</p>
<p>（3）拉取最新的一页帖子：selecttiezi-id&#x2F; order by time&#x2F; limit 100</p>
<p>所以往往要有一个time字段，并且在time字段上建立普通索引（non-cluster index）。</p>
<p>我们都知道普通索引存储的是实际记录的指针，其访问效率会比聚集索引慢，如果记录标识在生成时能够基本按照时间有序，则可以省去这个time字段的索引查询：</p>
<p>select message-id&#x2F; (order by message-id)&#x2F;limit 100</p>
<p>再次强调，能这么做的前提是，message-id的生成基本是<strong>趋势时间递增的</strong>。</p>
<p>这就引出了记录标识生成（也就是上文提到的三个XXX-id）的两大核心需求：</p>
<p>（1）全局唯一</p>
<p>（2）趋势有序</p>
<p>这也是本文要讨论的核心问题：<strong>如何高效生成趋势有序的全局唯一ID。</strong></p>
<p><strong>二、常见方法、不足与优化</strong></p>
<p><strong>【常见方法一：使用数据库的 auto_increment 来生成全局唯一递增ID】</strong></p>
<p><strong>优点：</strong></p>
<p>（1）简单，使用数据库已有的功能</p>
<p>（2）能够保证唯一性</p>
<p>（3）能够保证递增性</p>
<p>（4）步长固定</p>
<p><strong>缺点：</strong></p>
<p>（1）可用性难以保证：数据库常见架构是一主多从+读写分离，生成自增ID是写请求，主库挂了就玩不转了</p>
<p>（2）扩展性差，性能有上限：因为写入是单点，数据库主库的写性能决定ID的生成性能上限，并且难以扩展</p>
<p><strong>改进方法：</strong></p>
<p>（1）增加主库，避免写入单点</p>
<p>（2）数据水平切分，保证各主库生成的ID不重复</p>
<img src="/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/IMG-20250804110742685.png" class="">  
<p>如上图所述，由1个写库变成3个写库，<strong>每个写库设置不同的auto_increment初始值，以及相同的增长步长</strong>，以保证每个数据库生成的ID是不同的（上图中库0生成0,3,6,9…，库1生成1,4,7,10，库2生成2,5,8,11…）</p>
<p>改进后的架构保证了可用性，但<strong>缺点</strong>是：</p>
<p>（1）丧失了ID生成的“绝对递增性”：先访问库0生成0,3，再访问库1生成1，可能导致在非常短的时间内，ID生成不是绝对递增的（这个问题不大，我们的目标是趋势递增，不是绝对递增）</p>
<p>（2）数据库的写压力依然很大，每次生成ID都要访问数据库</p>
<p>为了解决上述两个问题，引出了第二个常见的方案</p>
<p><strong>【常见方法二：单点批量ID生成服务】</strong></p>
<p>分布式系统之所以难，很重要的原因之一是“没有一个全局时钟，难以保证绝对的时序”，要想保证绝对的时序，还是只能使用单点服务，用本地时钟保证“绝对时序”。数据库写压力大，是因为每次生成ID都访问了数据库，可以使用批量的方式降低数据库写压力。</p>
<img src="/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/IMG-20250804110742685.png" class="">  
<p>如上图所述，数据库使用双master保证可用性，数据库中只存储当前ID的最大值，例如0。ID生成服务假设每次批量拉取6个ID，服务访问数据库，将当前ID的最大值修改为5，这样应用访问ID生成服务索要ID，ID生成服务不需要每次访问数据库，就能依次派发0,1,2,3,4,5这些ID了，当ID发完后，再将ID的最大值修改为11，就能再次派发6,7,8,9,10,11这些ID了，于是数据库的压力就降低到原来的1&#x2F;6了。</p>
<p><strong>优点</strong>：</p>
<p>（1）保证了ID生成的绝对递增有序</p>
<p>（2）大大的降低了数据库的压力，ID生成可以做到每秒生成几万几十万个</p>
<p><strong>缺点</strong>：</p>
<p>（1）服务仍然是单点</p>
<p>（2）如果服务挂了，服务重启起来之后，继续生成ID可能会不连续，中间出现空洞（服务内存是保存着0,1,2,3,4,5，数据库中max-id是5，分配到3时，服务重启了，下次会从6开始分配，4和5就成了空洞，不过这个问题也不大）</p>
<p>（3）虽然每秒可以生成几万几十万个ID，但毕竟还是有性能上限，无法进行水平扩展</p>
<p><strong>改进方法</strong>：</p>
<p>单点服务的常用高可用优化方案是“备用服务”，也叫“影子服务”，所以我们能用以下方法优化上述缺点（1）：</p>
<p>如上图，对外提供的服务是主服务，有一个影子服务时刻处于备用状态，当主服务挂了的时候影子服务顶上。这个切换的过程对调用方是透明的，可以自动完成，常用的技术是vip+keepalived，具体就不在这里展开。</p>
<p> <img src="/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/IMG-20250804110742685.png" class=""></p>
<p><strong>【常见方法三：uuid】</strong></p>
<p>上述方案来生成ID，虽然性能大增，但由于是单点系统，总还是存在性能上限的。同时，上述两种方案，不管是数据库还是服务来生成ID，业务方Application都需要进行一次远程调用，比较耗时。有没有一种本地生成ID的方法，即高性能，又时延低呢？</p>
<p>uuid是一种常见的方案：string ID &#x3D;GenUUID();</p>
<p><strong>优点</strong>：</p>
<p>（1）本地生成ID，不需要进行远程调用，时延低</p>
<p>（2）扩展性好，基本可以认为没有性能上限</p>
<p><strong>缺点</strong>：</p>
<p>（1）无法保证趋势递增</p>
<p>（2）uuid过长，往往用字符串表示，作为主键建立索引查询效率低，常见优化方案为“转化为两个uint64整数存储”或者“折半存储”（折半后不能保证唯一性）</p>
<p><strong>【常见方法四：取当前毫秒数】</strong></p>
<p>uuid是一个本地算法，生成性能高，但无法保证趋势递增，且作为字符串ID检索效率低，有没有一种能保证递增的本地算法呢？</p>
<p>取当前毫秒数是一种常见方案：uint64 ID &#x3D; GenTimeMS();</p>
<p><strong>优点</strong>：</p>
<p>（1）本地生成ID，不需要进行远程调用，时延低</p>
<p>（2）生成的ID趋势递增</p>
<p>（3）生成的ID是整数，建立索引后查询效率高</p>
<p><strong>缺点</strong>：</p>
<p>（1）如果并发量超过1000，会生成重复的ID</p>
<p>我去，这个缺点要了命了，不能保证ID的唯一性。当然，使用微秒可以降低冲突概率，但每秒最多只能生成1000000个ID，再多的话就一定会冲突了，所以使用微秒并不从根本上解决问题。</p>
<p><strong>【常见方法五：类snowflake算法】</strong></p>
<p>snowflake是twitter开源的分布式ID生成算法，其<strong>核心思想</strong>是：一个long型的ID，使用其中41bit作为毫秒数，10bit作为机器编号，12bit作为毫秒内序列号。这个算法单机每秒内理论上最多可以生成1000*(2^12)，也就是400W的ID，完全能满足业务的需求。</p>
<p>借鉴snowflake的思想，结合各公司的业务逻辑和并发量，可以实现自己的分布式ID生成算法。</p>
<p>举例，假设某公司ID生成器服务的需求如下：</p>
<p>（1）单机高峰并发量小于1W，预计未来5年单机高峰并发量小于10W</p>
<p>（2）有2个机房，预计未来5年机房数量小于4个</p>
<p>（3）每个机房机器数小于100台</p>
<p>（4）目前有5个业务线有ID生成需求，预计未来业务线数量小于10个</p>
<p>（5）…</p>
<p>分析过程如下：</p>
<p>（1）高位取从2016年1月1日到现在的毫秒数（假设系统ID生成器服务在这个时间之后上线），假设系统至少运行10年，那至少需要10年*365天*24小时*3600秒*1000毫秒=320*10^9，差不多预留39bit给毫秒数</p>
<p>（2）每秒的单机高峰并发量小于10W，即平均每毫秒的单机高峰并发量小于100，差不多预留7bit给每毫秒内序列号</p>
<p>（3）5年内机房数小于4个，预留2bit给机房标识</p>
<p>（4）每个机房小于100台机器，预留7bit给每个机房内的服务器标识</p>
<p>（5）业务线小于10个，预留4bit给业务线标识</p>
<img src="/2017/01/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E6%96%B9%E6%B3%95%E7%94%9F%E6%88%90%E6%BC%94%E5%8F%98/IMG-20250804110742877.png" class="">  
<p>这样设计的64bit标识，可以保证：</p>
<p>（1）每个业务线、每个机房、每个机器生成的ID都是不同的</p>
<p>（2）同一个机器，每个毫秒内生成的ID都是不同的</p>
<p>（3）同一个机器，同一个毫秒内，以序列号区区分保证生成的ID是不同的</p>
<p>（4）将毫秒数放在最高位，保证生成的ID是趋势递增的</p>
<p><strong>缺点</strong>：</p>
<p>（1）由于“没有一个全局时钟”，每台服务器分配的ID是绝对递增的，但从全局看，生成的ID只是趋势递增的（有些服务器的时间早，有些服务器的时间晚）</p>
<p><strong>最后一个容易忽略的问题</strong>：</p>
<p>生成的ID，例如message-id&#x2F; order-id&#x2F; tiezi-id，在数据量大时往往需要分库分表，这些ID经常作为取模分库分表的依据，为了分库分表后数据均匀，ID生成往往有“取模随机性”的需求，所以我们通常把每秒内的序列号放在ID的最末位，保证生成的ID是随机的。</p>
<p>又如果，我们在跨毫秒时，序列号总是归0，会使得序列号为0的ID比较多，导致生成的ID取模后不均匀。解决方法是，序列号不是每次都归0，而是归一个0到9的随机数，这个地方。</p>
<p>下面附上C#.Net 实现snowflake算法实现</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CommonTools</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SnowFlake</span></span><br><span class="line">    &#123;</span><br><span class="line">             <span class="comment">//机器ID</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> workerId;</span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> twepoch = <span class="number">687888001020L</span>; <span class="comment">//唯一时间，这是一个避免重复的随机量，自行设定不要大于当前时间戳</span></span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">long</span> sequence = <span class="number">0L</span>;</span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> workerIdBits = <span class="number">4</span>; <span class="comment">//机器码字节数。4个字节用来保存机器码</span></span><br><span class="line">	    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> maxWorkerId = <span class="number">-1L</span> ^ <span class="number">-1L</span> &lt;&lt; workerIdBits; <span class="comment">//最大机器ID</span></span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> sequenceBits = <span class="number">10</span>; <span class="comment">//计数器字节数，10个字节用来保存计数码</span></span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> workerIdShift = sequenceBits; <span class="comment">//机器码数据左移位数，就是后面计数器占用的位数</span></span><br><span class="line">	    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> timestampLeftShift = sequenceBits + workerIdBits; <span class="comment">//时间戳左移动位数就是机器码和计数器总字节数</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> sequenceMask = <span class="number">-1L</span> ^ <span class="number">-1L</span> &lt;&lt; sequenceBits; <span class="comment">//一微秒内可以产生计数，如果达到该值则等到下一微妙在进行生成</span></span><br><span class="line">	    <span class="keyword">private</span> <span class="built_in">long</span> lastTimestamp = <span class="number">-1L</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SnowFlake sigle = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span>  <span class="title">SnowFlake</span>(<span class="params"><span class="built_in">long</span> workerId</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (workerId &gt; maxWorkerId || workerId &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="built_in">string</span>.Format(<span class="string">&quot;worker Id can&#x27;t be greater than &#123;0&#125; or less than 0 &quot;</span>, workerId));</span><br><span class="line">            SnowFlake.workerId = workerId;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">long</span> <span class="title">NewID</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sigle == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sigle = <span class="keyword">new</span> SnowFlake(<span class="number">4L</span>); <span class="comment">//此处4L应该从配置文件里读取当前机器配置</span></span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">return</span>  sigle.nextId();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">long</span> <span class="title">nextId</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">lock</span> (<span class="keyword">this</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">long</span> timestamp = timeGen();</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>.lastTimestamp == timestamp)&#123; <span class="comment">//同一微妙中生成ID</span></span><br><span class="line">                    <span class="comment">//用&amp;运算计算该微秒内产生的计数是否已经到达上限</span></span><br><span class="line">                    SnowFlake.sequence = (SnowFlake.sequence + <span class="number">1</span>) &amp; SnowFlake.sequenceMask; </span><br><span class="line">                    <span class="keyword">if</span> (SnowFlake.sequence == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//一微妙内产生的ID计数已达上限，等待下一微妙</span></span><br><span class="line">                        timestamp = tillNextMillis(<span class="keyword">this</span>.lastTimestamp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123; <span class="comment">//不同微秒生成ID</span></span><br><span class="line">                    SnowFlake.sequence = <span class="number">0</span>; <span class="comment">//计数清0</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(timestamp &lt; lastTimestamp)</span><br><span class="line">                &#123; <span class="comment">//如果当前时间戳比上一次生成ID时时间戳还小，抛出异常，因为不能保证现在生成的ID之前没有生成过</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="built_in">string</span>.Format(<span class="string">&quot;Clock moved backwards.  Refusing to generate id for &#123;0&#125; milliseconds&quot;</span>,</span><br><span class="line">                        <span class="keyword">this</span>.lastTimestamp - timestamp));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.lastTimestamp = timestamp; <span class="comment">//把当前时间戳保存为最后生成ID的时间戳</span></span><br><span class="line">                <span class="built_in">long</span> nextId = (timestamp - twepoch &lt;&lt; timestampLeftShift) </span><br><span class="line">                    | SnowFlake.workerId &lt;&lt; SnowFlake.workerIdShift | SnowFlake.sequence;</span><br><span class="line">                <span class="keyword">return</span> nextId;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取下一微秒时间戳</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lastTimestamp&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">long</span> <span class="title">tillNextMillis</span>(<span class="params"><span class="built_in">long</span> lastTimestamp</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">long</span> timestamp = timeGen();</span><br><span class="line">            <span class="keyword">while</span>(timestamp &lt;= lastTimestamp)</span><br><span class="line">            &#123;</span><br><span class="line">                timestamp = timeGen();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> timestamp;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成当前时间戳</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">long</span> <span class="title">timeGen</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">long</span>)(DateTime.UtcNow - <span class="keyword">new</span> DateTime(<span class="number">1970</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, DateTimeKind.Utc)).TotalMilliseconds;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/11/14/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Shiro%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E9%99%86%E3%80%81%E6%8E%88%E6%9D%83%E3%80%81%E6%8B%A6%E6%88%AA%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/11/14/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Shiro%20%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E9%99%86%E3%80%81%E6%8E%88%E6%9D%83%E3%80%81%E6%8B%A6%E6%88%AA%E5%99%A8/" class="post-title-link" itemprop="url">Shiro</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-11-14 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-14T00:00:00+08:00">2015-11-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h2><ul>
<li>登陆、授权、拦截</li>
<li>按钮权限控制</li>
</ul>
<h2 id="一、目标"><a href="#一、目标" class="headerlink" title="一、目标"></a>一、目标</h2><ul>
<li>Maven+Spring+shiro</li>
<li>自定义登陆、授权</li>
<li>自定义拦截器</li>
<li>加载数据库资源构建拦截链</li>
</ul>
<p>使用总结：</p>
<p>1、需要设计的数据库：用户、角色、权限、资源</p>
<p>2、可以通过，角色，权限，两个拦截器同时确定是否能访问</p>
<p>3、角色与权限的关系，role1&#x3D;permission1,permission2，多级的权限：sys:permission1,拥有高级权限同时用于低级权限。</p>
<p>4、perms[“permission1”] 为权限</p>
<p>5、拦截器机制介绍了拦截角色还是权限</p>
<p>6、角色与权限 是两个概念</p>
<p>7、权限-资源，一对一。资源分为上下级，因此权限分为父权限，子权限。创建资源的时候，创建权限。权限里资源的别名</p>
<p>8、角色-权限，一对多。角色里权限的别名</p>
<p>9、按钮是通过权限来控制的</p>
<p>10、防止有父级资源可以访问，子级资源不能访问的情况，不适用 sys:add 权限写法</p>
<h2 id="二、代码"><a href="#二、代码" class="headerlink" title="二、代码"></a>二、代码</h2><h3 id="1、Pom-xml"><a href="#1、Pom-xml" class="headerlink" title="1、Pom.xml"></a>1、Pom.xml</h3><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1     &lt;properties&gt;<br> 2         &lt;spring.version&gt;4.3.4.RELEASE&lt;&#x2F;spring.version&gt;<br> 3     &lt;&#x2F;properties&gt;<br> 4         &lt;dependency&gt;<br> 5             &lt;groupId&gt;junit&lt;&#x2F;groupId&gt;<br> 6             &lt;artifactId&gt;junit&lt;&#x2F;artifactId&gt;<br> 7             &lt;version&gt;4.9&lt;&#x2F;version&gt;<br> 8         &lt;&#x2F;dependency&gt;<br> 9         &lt;dependency&gt;<br>10             &lt;groupId&gt;commons-logging&lt;&#x2F;groupId&gt;<br>11             &lt;artifactId&gt;commons-logging&lt;&#x2F;artifactId&gt;<br>12             &lt;version&gt;1.1.3&lt;&#x2F;version&gt;<br>13         &lt;&#x2F;dependency&gt;<br>14         &lt;dependency&gt;<br>15             &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;<br>16             &lt;artifactId&gt;shiro-core&lt;&#x2F;artifactId&gt;<br>17             &lt;version&gt;1.2.2&lt;&#x2F;version&gt;<br>18         &lt;&#x2F;dependency&gt;<br>19         &lt;dependency&gt;<br>20             &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;<br>21             &lt;artifactId&gt;shiro-spring&lt;&#x2F;artifactId&gt;<br>22             &lt;version&gt;1.2.2&lt;&#x2F;version&gt;<br>23         &lt;&#x2F;dependency&gt;<br>24         &lt;dependency&gt;<br>25             &lt;groupId&gt;javax.servlet&lt;&#x2F;groupId&gt;<br>26             &lt;artifactId&gt;javax.servlet-api&lt;&#x2F;artifactId&gt;<br>27             &lt;version&gt;3.0.1&lt;&#x2F;version&gt;<br>28             &lt;scope&gt;provided&lt;&#x2F;scope&gt;<br>29         &lt;&#x2F;dependency&gt;<br>30         &lt;dependency&gt;<br>31             &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;<br>32             &lt;artifactId&gt;spring-web&lt;&#x2F;artifactId&gt;<br>33             &lt;version&gt;${spring.version}&lt;&#x2F;version&gt;<br>34         &lt;&#x2F;dependency&gt;<br>35         <dependency><br>36             <groupId>org.apache.shiro</groupId><br>37             <artifactId>shiro-ehcache</artifactId><br>38             <version>1.2.2</version><br>39         </dependency><br>40         <dependency><br>41             <groupId>org.springframework</groupId><br>42             <artifactId>spring-context</artifactId><br>43             <version>${spring.version}</version><br>44         </dependency><br>45         <dependency><br>46             <groupId>org.apache.shiro</groupId><br>47             <artifactId>shiro-web</artifactId><br>48             <version>1.2.2</version><br>49         </dependency><br>50         <dependency><br>51             <groupId>net.sf.ehcache</groupId><br>52             <artifactId>ehcache</artifactId><br>53             <version>2.10.1</version><br>54     </dependency> </p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="2、web-xml"><a href="#2、web-xml" class="headerlink" title="2、web.xml"></a>2、web.xml</h3><p>　　Servlet拦截访问，使用注解更方便，需要删除项目中的servlet使用javax.servlet-api 3.0 包</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1 package com.cyd.shiro;<br> 2<br> 3 import java.io.IOException;<br> 4<br> 5 import javax.servlet.ServletException;<br> 6 import javax.servlet.annotation.WebServlet;<br> 7 import javax.servlet.http.HttpServlet;<br> 8 import javax.servlet.http.HttpServletRequest;<br> 9 import javax.servlet.http.HttpServletResponse;<br>10<br>11 import org.apache.shiro.SecurityUtils;<br>12 import org.apache.shiro.authc.AuthenticationException;<br>13 import org.apache.shiro.authc.IncorrectCredentialsException;<br>14 import org.apache.shiro.authc.UnknownAccountException;<br>15 import org.apache.shiro.authc.UsernamePasswordToken;<br>16 import org.apache.shiro.subject.Subject;<br>17 import org.apache.shiro.web.util.SavedRequest;<br>18 import org.apache.shiro.web.util.WebUtils;<br>19 import org.junit.Test;<br>20<br>21 @WebServlet(name &#x3D; “loginServlet”, urlPatterns &#x3D; “&#x2F;loginController”)<br>22 public class LoginServlet extends HttpServlet {<br>23     @Override<br>24     protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {<br>25         req.getRequestDispatcher(“login.jsp”).forward(req, resp);<br>26     }<br>27<br>28     @Override<br>29     protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {<br>30         System.out.println(LoginServlet.class.toString());<br>31         String error &#x3D; null;<br>32         String username &#x3D; req.getParameter(“username”);<br>33         String password &#x3D; req.getParameter(“password”);<br>34         Subject subject &#x3D; SecurityUtils.getSubject();<br>35         UsernamePasswordToken token &#x3D; new UsernamePasswordToken(username, password);<br>36         try {<br>37             subject.login(token);<br>38         } catch (UnknownAccountException e) {<br>39             error &#x3D; “用户名&#x2F;密码错误”;<br>40         } catch (IncorrectCredentialsException e) {<br>41             error &#x3D; “用户名&#x2F;密码错误”;<br>42         } catch (AuthenticationException e) {<br>43             &#x2F;&#x2F; 其他错误，比如锁定，如果想单独处理请单独catch处理<br>44             error &#x3D; “其他错误：” + e.getMessage();<br>45         }<br>46         if (error !&#x3D; null) {&#x2F;&#x2F; 出错了，返回登录页面<br>47             req.setAttribute(“error”, error);<br>48             req.getRequestDispatcher(“login.jsp”).forward(req, resp);<br>49         } else {&#x2F;&#x2F; 登录成功<br>50             &#x2F;&#x2F;跳转到拦截登陆前的地址<br>51             SavedRequest request&#x3D;WebUtils.getSavedRequest(req);<br>52             String url &#x3D;request.getRequestURI();<br>53             req.getRequestDispatcher(url.substring(url.lastIndexOf(‘&#x2F;‘))).forward(req, resp);<br>54         }<br>55     }<br>56<br>57 }</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="3、Spring-shiro-xml"><a href="#3、Spring-shiro-xml" class="headerlink" title="3、Spring-shiro.xml"></a>3、Spring-shiro.xml</h3><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<?xml version="1.0" encoding="UTF-8"?>
<p>&lt;beans xmlns=“<a target="_blank" rel="noopener" href="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</a>“ xmlns:xsi=“<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</a>“ xmlns:context=“<a target="_blank" rel="noopener" href="http://www.springframework.org/schema/context">http://www.springframework.org/schema/context</a>“ xmlns:util=“<a target="_blank" rel="noopener" href="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</a>“ xsi:schemaLocation=“<a target="_blank" rel="noopener" href="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</a><br>    <a target="_blank" rel="noopener" href="http://www.springframework.org/schema/beans/spring-beans.xsd">http://www.springframework.org/schema/beans/spring-beans.xsd</a><br>    <a target="_blank" rel="noopener" href="http://www.springframework.org/schema/context">http://www.springframework.org/schema/context</a><br>    <a target="_blank" rel="noopener" href="http://www.springframework.org/schema/context/spring-context.xsd">http://www.springframework.org/schema/context/spring-context.xsd</a><br>    <a target="_blank" rel="noopener" href="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</a><br>    <a target="_blank" rel="noopener" href="http://www.springframework.org/schema/util/spring-util-4.2.xsd%22/%3E">http://www.springframework.org/schema/util/spring-util-4.2.xsd&quot;\&gt;</a></p>
<pre><code>&lt;context:component-scan base-package\=&quot;com.cyd.shiro.\*&quot;\&gt;&lt;/context:component-scan\&gt;

&lt;!-- Shiro的Web过滤器 \--&gt;
&lt;bean id\=&quot;shiroFilter&quot; class\=&quot;com.cyd.shiro.ExtendShiroFilterFactoryBean&quot;\&gt;
    &lt;property name\=&quot;securityManager&quot; ref\=&quot;securityManager&quot; /&gt;
    &lt;property name\=&quot;loginUrl&quot; value\=&quot;/login.jsp&quot; /&gt;
    &lt;!-- &lt;property name=&quot;successUrl&quot; value=&quot;/index.jsp&quot; /&gt; \--&gt;
    &lt;property name\=&quot;unauthorizedUrl&quot; value\=&quot;/unauthorized.jsp&quot; /&gt;
    &lt;property name\=&quot;filters&quot;\&gt;
        &lt;util:map\&gt;
            &lt;!-- &lt;entry key=&quot;onperms&quot; value-ref=&quot;URLPermissionsFilter&quot; /&gt; \--&gt;
            &lt;entry key\=&quot;onrole&quot; value-ref\=&quot;ExtendRolesAuthorizationFilter&quot; /&gt;
        &lt;/util:map\&gt;
    &lt;/property\&gt; 
    &lt;property name\=&quot;filterChainDefinitions&quot;\&gt;
        &lt;value\&gt; /unauthorized.jsp = anon
            /logoutController=anon
            /login.jsp=authc
        &lt;/value\&gt;
    &lt;/property\&gt;
&lt;/bean\&gt;

&lt;!-- 安全管理器 \--&gt;
&lt;bean id\=&quot;securityManager&quot; class\=&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;\&gt;
    &lt;property name\=&quot;realm&quot; ref\=&quot;myRealm&quot; /&gt;
    &lt;property name\=&quot;cacheManager&quot; ref\=&quot;cacheManager&quot; /&gt;
&lt;/bean\&gt;
&lt;!-- 自定义认证，授权 \--&gt;
&lt;bean id\=&quot;myRealm&quot; class\=&quot;com.cyd.shiro.AdminRealm&quot;\&gt;&lt;/bean\&gt;

&lt;!-- 注册ehcache，不然每次访问都要登陆 \--&gt;
&lt;bean id\=&quot;cacheManager&quot; class\=&quot;org.apache.shiro.cache.ehcache.EhCacheManager&quot;\&gt;
    &lt;property name\=&quot;cacheManagerConfigFile&quot; value\=&quot;classpath:ehcache.xml&quot; /&gt;
&lt;/bean\&gt;
&lt;!-- 自定义鉴权拦截器 \--&gt;
&lt;bean id\=&quot;URLPermissionsFilter&quot; class\=&quot;com.cyd.shiro.URLPermissionsFilter&quot; /&gt;
&lt;bean id\=&quot;ExtendRolesAuthorizationFilter&quot; class\=&quot;com.cyd.shiro.ExtendRolesAuthorizationFilter&quot; /&gt;
</code></pre>
<p>&lt;&#x2F;beans&gt;</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="4、Ehcache-xml-缓存"><a href="#4、Ehcache-xml-缓存" class="headerlink" title="4、Ehcache.xml 缓存"></a>4、Ehcache.xml 缓存</h3><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<?xml version="1.0" encoding="UTF-8"?>
<p>&lt;ehcache xmlns:xsi=“<a target="_blank" rel="noopener" href="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</a>“ xsi:noNamespaceSchemaLocation=“..&#x2F;config&#x2F;ehcache.xsd”&gt;<br>&lt;diskStore path=“java.io.tmpdir”&#x2F;&gt;<br>&lt;defaultCache<br>        maxElementsInMemory=“10000” eternal=“false” timeToIdleSeconds=“600” timeToLiveSeconds=“600” overflowToDisk=“true” maxElementsOnDisk=“10000000” diskPersistent=“false” diskExpiryThreadIntervalSeconds=“120” memoryStoreEvictionPolicy=“LRU”<br>        &#x2F;&gt;</p>
<!-- 内存中最多可以存储多少个数据 
    是否永久有效
    空闲时间
    存活时间
    内存空间不够是否存储到磁盘
    磁盘最大存储个数
    服务器重启,磁盘数据是否需要
    线程
    淘汰策略(最近最少使用)  
 \-->  
<p>&lt;&#x2F;ehcache&gt;</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="5、登陆Servlet"><a href="#5、登陆Servlet" class="headerlink" title="5、登陆Servlet"></a>5、登陆Servlet</h3><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>package com.cyd.shiro;</p>
<p>import java.io.IOException;</p>
<p>import javax.servlet.ServletException;<br>import javax.servlet.annotation.WebServlet;<br>import javax.servlet.http.HttpServlet;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;</p>
<p>import org.apache.shiro.SecurityUtils;<br>import org.apache.shiro.authc.AuthenticationException;<br>import org.apache.shiro.authc.IncorrectCredentialsException;<br>import org.apache.shiro.authc.UnknownAccountException;<br>import org.apache.shiro.authc.UsernamePasswordToken;<br>import org.apache.shiro.subject.Subject;<br>import org.apache.shiro.web.util.SavedRequest;<br>import org.apache.shiro.web.util.WebUtils;</p>
<p>@WebServlet(name &#x3D; “loginServlet”, urlPatterns &#x3D; “&#x2F;loginController”)<br>public class LoginServlet extends HttpServlet {<br>    @Override<br>    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {<br>        req.getRequestDispatcher(“login.jsp”).forward(req, resp);<br>    }</p>
<pre><code>@Override
protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123;
    System.out.println(LoginServlet.class.toString());
    String error = null;
    String username = req.getParameter(&quot;username&quot;);
    String password = req.getParameter(&quot;password&quot;);
    Subject subject = SecurityUtils.getSubject();
    UsernamePasswordToken token = new UsernamePasswordToken(username, password);
    try &#123;
        subject.login(token); 
    &#125; catch (UnknownAccountException e) &#123; 
        error = &quot;用户名/密码错误&quot;;
    &#125; catch (IncorrectCredentialsException e) &#123;
        error = &quot;用户名/密码错误&quot;;
    &#125; catch (AuthenticationException e) &#123;
        // 其他错误，比如锁定，如果想单独处理请单独catch处理
        error = &quot;其他错误：&quot; + e.getMessage();
    &#125;
    if (error != null) &#123;// 出错了，返回登录页面
        req.setAttribute(&quot;error&quot;, error);
        req.getRequestDispatcher(&quot;login.jsp&quot;).forward(req, resp);
    &#125; else &#123;// 登录成功
        //跳转到拦截登陆前的地址
        SavedRequest request=WebUtils.getSavedRequest(req);
        String url =request.getRequestURI();
        req.getRequestDispatcher(url.substring(url.lastIndexOf(&#39;/&#39;))).forward(req, resp);
    &#125;
&#125;
</code></pre>
<p>}</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="6、自定义登陆、授权。"><a href="#6、自定义登陆、授权。" class="headerlink" title="6、自定义登陆、授权。"></a>6、自定义登陆、授权。</h3><p>　　根据需求自定义登陆异常。从数据库查询出当前用户拥有的权限并授权</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1 package com.cyd.shiro;<br> 2<br> 3 import java.util.HashSet;<br> 4 import java.util.LinkedList;<br> 5 import java.util.List;<br> 6 import java.util.Set;<br> 7<br> 8 import org.apache.shiro.authc.AuthenticationException;<br> 9 import org.apache.shiro.authc.AuthenticationInfo;<br>10 import org.apache.shiro.authc.AuthenticationToken;<br>11 import org.apache.shiro.authc.SimpleAuthenticationInfo;<br>12 import org.apache.shiro.authc.UnknownAccountException;<br>13 import org.apache.shiro.authz.AuthorizationInfo;<br>14 import org.apache.shiro.authz.SimpleAuthorizationInfo;<br>15 import org.apache.shiro.realm.AuthorizingRealm;<br>16 import org.apache.shiro.subject.PrincipalCollection;<br>17 import org.springframework.beans.factory.annotation.Autowired;<br>18<br>19 import com.cyd.helloworld.SysRoles;<br>20 import com.cyd.helloworld.SysUsers;<br>21 import com.cyd.shiro.admin.SysUsersService;<br>22<br>23 public class AdminRealm extends AuthorizingRealm {<br>24<br>25     @Autowired<br>26     private SysUsersService    sysusersservice;<br>27     &#x2F;&#x2F; 认证登陆<br>28     @Override<br>29     protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {<br>30         System.out.println(“do doGetAuthenticationInfo”);<br>31         String username &#x3D; (String) token.getPrincipal();<br>32         SysUsers user &#x3D; sysusersservice.getSysUsers(username);<br>33         if (user &#x3D;&#x3D; null) {<br>34             throw new UnknownAccountException();&#x2F;&#x2F; 没找到帐号<br>35         }<br>36         SimpleAuthenticationInfo authenticationInfo &#x3D; new SimpleAuthenticationInfo(user.getUserName(), &#x2F;&#x2F; 用户名<br>37                 user.getPassWorld(), &#x2F;&#x2F; 密码<br>38                 getName() &#x2F;&#x2F; realm name<br>39         );<br>40         return authenticationInfo;<br>41     }<br>42<br>43     &#x2F;&#x2F; 用户授权<br>44     @Override<br>45     protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {<br>46         System.out.println(“do doGetAuthorizationInfo”);<br>47         String username &#x3D; (String)principals.getPrimaryPrincipal();<br>48         SimpleAuthorizationInfo authorizationInfo &#x3D; new SimpleAuthorizationInfo();<br>49         &#x2F;&#x2F;从数据库加载当前用户的角色，例如：[admin]<br>50         authorizationInfo.setRoles(new HashSet<String>(sysusersservice.getSysRoles(username)));<br>51         &#x2F;&#x2F;从数据库加载当前用户可以访问的资源，例如：[index.jsp, abc.jsp]<br>52         authorizationInfo.setStringPermissions(new HashSet<String>(sysusersservice.getSysResource(username)));<br>53<br>54         return authorizationInfo;<br>55     }<br>56 }</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h3 id="7、自定义拦截器。"><a href="#7、自定义拦截器。" class="headerlink" title="7、自定义拦截器。"></a>7、自定义拦截器。</h3><p>　　重写拦截器是因为shiro 验证是否有权限访问是需要当前用户拥有拦截器链的所有权限。一般需求只需要拥有部分权限即可。</p>
<p>       角色验证拦截，hasRole和hasAllRoles 验证是否有权限。</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1 package com.cyd.shiro;<br> 2<br> 3 import java.io.IOException;<br> 4 import java.util.Set;<br> 5<br> 6 import javax.servlet.ServletRequest;<br> 7 import javax.servlet.ServletResponse;<br> 8<br> 9 import org.apache.shiro.subject.Subject;<br>10 import org.apache.shiro.util.CollectionUtils;<br>11 import org.apache.shiro.web.filter.authz.RolesAuthorizationFilter;<br>12<br>13 &#x2F;**<br>14  * 通过角色验证权限<br>15  * @author chenyd<br>16  * 2017年11月21日<br>17  *&#x2F;<br>18 public class ExtendRolesAuthorizationFilter extends RolesAuthorizationFilter{<br>19<br>20     @Override<br>21     public boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) throws IOException {<br>22<br>23         System.out.println(ExtendRolesAuthorizationFilter.class.toString());<br>24         Subject subject &#x3D; getSubject(request, response);<br>25         String[] rolesArray &#x3D; (String[]) mappedValue;<br>26<br>27         if (rolesArray &#x3D;&#x3D; null || rolesArray.length &#x3D;&#x3D; 0) {<br>28             &#x2F;&#x2F;no roles specified, so nothing to check - allow access.<br>29             return true;<br>30         }<br>31         &#x2F;&#x2F;AbstractFilter<br>32         Set<String> roles &#x3D; CollectionUtils.asSet(rolesArray);<br>33<br>34         boolean flag&#x3D;false;<br>35         for(String role: roles){<br>36             if(subject.hasRole(role)){<br>37                 flag&#x3D;true;<br>38                 break;<br>39             }<br>40         }<br>41         return flag;<br>42     }<br>43 }</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>       url拦截校验，isPermitted和isPermittedAll验证是否有权限访问，</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1 package com.cyd.shiro;<br> 2<br> 3 import java.io.IOException;<br> 4<br> 5 import javax.servlet.ServletRequest;<br> 6 import javax.servlet.ServletResponse;<br> 7 import javax.servlet.http.HttpServletRequest;<br> 8<br> 9 import org.apache.shiro.subject.Subject;<br>10 import org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter;<br>11 &#x2F;**<br>12  * 通过字符串验证权限<br>13  * @author chenyd<br>14  * 2017年11月21日<br>15  *&#x2F;<br>16 public class URLPermissionsFilter extends PermissionsAuthorizationFilter {<br>17<br>18     &#x2F;**<br>19      * mappedValue 访问该url时需要的权限<br>20      * subject.isPermitted 判断访问的用户是否拥有mappedValue权限<br>21      * 重写拦截器，只要符合配置的一个权限，即可通过<br>22      *&#x2F;<br>23     @Override<br>24     public boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue)<br>25             throws IOException {<br>26         System.out.println(URLPermissionsFilter.class.toString());<br>27         Subject subject &#x3D; getSubject(request, response);<br>28         &#x2F;&#x2F; DefaultFilterChainManager<br>29         &#x2F;&#x2F; PathMatchingFilterChainResolver<br>30         String[] perms &#x3D; (String[]) mappedValue;<br>31         boolean isPermitted &#x3D; false;<br>32         if (perms !&#x3D; null &amp;&amp; perms.length &gt; 0) {<br>33             for (String str : perms) {<br>34                 if (subject.isPermitted(str)) {<br>35                     isPermitted &#x3D; true;<br>36                 }<br>37             }<br>38         }<br>39<br>40         return isPermitted;<br>41     }<br>42 }</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h2 id="8、加载数据库资源构建拦截器链"><a href="#8、加载数据库资源构建拦截器链" class="headerlink" title="8、加载数据库资源构建拦截器链"></a>8、加载数据库资源构建拦截器链</h2><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> 1 package com.cyd.shiro;<br> 2<br> 3 import java.util.Map;<br> 4<br> 5 import org.apache.shiro.config.Ini;<br> 6 import org.apache.shiro.spring.web.ShiroFilterFactoryBean;<br> 7 import org.apache.shiro.util.CollectionUtils;<br> 8 import org.apache.shiro.web.config.IniFilterChainResolverFactory;<br> 9 import org.springframework.beans.factory.annotation.Autowired;<br>10<br>11 import com.cyd.shiro.admin.SysUsersService;<br>12<br>13 public class ExtendShiroFilterFactoryBean extends ShiroFilterFactoryBean{<br>14<br>15     @Autowired<br>16     private SysUsersService    sysusersservice;<br>17     &#x2F;&#x2F;PathMatchingFilter<br>18     @Override<br>19     public void setFilterChainDefinitions(String definitions) {<br>20         &#x2F;&#x2F;数据库中获取权限，{&#x2F;index.jsp&#x3D;authc,onrole[“admin2”,”admin”], &#x2F;abc.jsp&#x3D;authc,onrole[“admin2”,”admin”]}<br>21         Map&lt;String, String&gt; otherChains &#x3D; sysusersservice.getFilterChain();<br>22         Ini ini &#x3D; new Ini();<br>23         ini.load(definitions);<br>24         Ini.Section section &#x3D; ini.getSection(IniFilterChainResolverFactory.URLS);<br>25         if (CollectionUtils.isEmpty(section)) {<br>26             section &#x3D; ini.getSection(Ini.DEFAULT_SECTION_NAME);<br>27         }<br>28         section.putAll(otherChains);<br>29         setFilterChainDefinitionMap(section);<br>30     }<br>31<br>32 }</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h2 id="三、-学习笔记"><a href="#三、-学习笔记" class="headerlink" title="三、  学习笔记"></a>三、  学习笔记</h2><h3 id="1、INI文件配置"><a href="#1、INI文件配置" class="headerlink" title="1、INI文件配置"></a>1、INI文件配置</h3><p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>[users]  #提供了对用户&#x2F;密码及其角色的配置，用户名&#x3D;密码，角色1，角色2  </p>
<p>zhang&#x3D;123,admin</p>
<p>[roles]  #提供了角色及权限之间关系的配置，角色&#x3D;权限1，权限2  </p>
<p>admin&#x3D;index.jsp</p>
<p>[urls] #配置拦截器链，&#x2F;** 为拦截器链名称（filterChain），authc,roles[admin],perms[“index.jsp”]拦截器列表名</p>
<p>&#x2F;login.jsp&#x3D;anon</p>
<p>&#x2F;loginController&#x3D;anon</p>
<p>&#x2F;unauthorized.jsp&#x3D;anon</p>
<p>&#x2F;**&#x3D;authc,roles[admin],perms[“index.jsp”] </p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<h2 id="2、拦截器链"><a href="#2、拦截器链" class="headerlink" title="2、拦截器链"></a>2、拦截器链</h2><p>　　Shiro的所有拦截器链名定义在源码DefaultFilter中。</p>
<p>anon            </p>
<p>例子&#x2F;admins&#x2F;**&#x3D;anon 没有参数，表示可以匿名使用。 </p>
<p>authc</p>
<p>例如&#x2F;admins&#x2F;user&#x2F;**&#x3D;authc表示需要认证(登录)才能使用，没有参数  </p>
<p>roles</p>
<p> 例子&#x2F;admins&#x2F;user&#x2F;**&#x3D;roles[admin],参数可以写多个，多个时必须加上引号，  </p>
<p> 并且参数之间用逗号分割，当有多个参数时，例如admins&#x2F;user&#x2F;**&#x3D;roles[“admin,guest”],  </p>
<p> 每个参数通过才算通过，相当于hasAllRoles()方法。  </p>
<p>perms</p>
<p>例子&#x2F;admins&#x2F;user&#x2F;**&#x3D;perms[user:add:*],参数可以写多个，多个时必须加上引号，并且参数之间用逗号分割，  </p>
<p>例如&#x2F;admins&#x2F;user&#x2F;**&#x3D;perms[“user:add:*,user:modify:*“]，当有多个参数时必须每个参数都通过才通过，  </p>
<p>想当于isPermitedAll()方法。</p>
<p>rest</p>
<p>例子&#x2F;admins&#x2F;user&#x2F;**&#x3D;rest[user],根据请求的方法，相当于&#x2F;admins&#x2F;user&#x2F;**&#x3D;perms[user:method] ,  </p>
<p> 其中method为post，get，delete等。</p>
<p>port</p>
<p>例子&#x2F;admins&#x2F;user&#x2F;**&#x3D;port[8081],当请求的url的端口不是8081是跳转到schemal:&#x2F;&#x2F;serverName:8081?queryString,  其中schmal是协议http或https等，serverName是你访问的host,8081是url配置里port的端口，queryString是你访问的url里的？后面的参数。</p>
<p>authcBasic                                 </p>
<p>例如&#x2F;admins&#x2F;user&#x2F;**&#x3D;authcBasic没有参数表示httpBasic认证</p>
<p>ssl</p>
<p>例子&#x2F;admins&#x2F;user&#x2F;**&#x3D;ssl没有参数，表示安全的url请求，协议为https</p>
<p>user</p>
<p>例如&#x2F;admins&#x2F;user&#x2F;**&#x3D;user没有参数表示必须存在用户，当登入操作时不做检查  </p>
<p><strong>注：anon，authcBasic，auchc，user是认证过滤器，</strong> </p>
<p> <strong>perms，roles，ssl，rest，port是授权过滤器</strong> </p>
<h3 id="3、拦截器链源码类关系图"><a href="#3、拦截器链源码类关系图" class="headerlink" title="3、拦截器链源码类关系图"></a>3、拦截器链源码类关系图</h3><p> <img src="https://images2017.cnblogs.com/blog/990457/201711/990457-20171122183041446-117461293.jpg"> </p>
<p>①   NameableFilter有一个name属性，定义每一个filter的名字。</p>
<p>②   OncePerRequestFilter保证客户端请求后该filter的doFilter只会执行一次。</p>
<p>　　doFilterInternal非常重要，在shiro整个filter体系中的核心方法及实质入口。另外，shiro是通过在request中设置一个该filter特定的属性值来保证该filter只会执行一次的。</p>
<p>③   AdviceFilter中主要是对doFilterInternal做了更细致的切分。</p>
<p>　　springmvc中的Interceptor，doFilterInternal会先调用preHandle做一些前置判断，如果返回false则filter链不继续往下执行，</p>
<p>④   AccessControlFilter中的对onPreHandle方法做了进一步细化。</p>
<p>　　isAccessAllowed方法和onAccessDenied方法达到控制效果。这两个方法都是抽象方法，由子类去实现。到这一层应该明白。isAccessAllowed和onAccessDenied方法会影响到onPreHandle方法，而onPreHandle方法会影响到preHandle方法，而preHandle方法会达到控制filter链是否执行下去的效果。所以如果正在执行的filter中isAccessAllowed和onAccessDenied都返回false，则整个filter控制链都将结束，不会到达目标方法（客户端请求的接口），而是直接跳转到某个页面（由filter定义的，将会在authc中看到）。</p>
<p>⑤   FormAuthenticationFiltershiro提供的登录的filter，</p>
<p>　　saveRequestAndRedirectToLogin保存request并拦截到登陆页面，登陆成功后可从WebUtils.getSavedRequest(req);中取出。</p>
<h2 id="四、未实现的功能"><a href="#四、未实现的功能" class="headerlink" title="四、未实现的功能"></a>四、未实现的功能</h2><ul>
<li>动态URL权限控制。当修改权限时，重新加载拦截器链。</li>
<li>密码加密</li>
<li>记住我</li>
<li>在线人数控制</li>
<li>集成验证码</li>
</ul>
<p>　</p>
<h2 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h2><blockquote>
<ul>
<li> spring mvc整合shiro登录 权限验证 　　<a target="_blank" rel="noopener" href="http://blog.csdn.net/rongku/article/details/51336424">http://blog.csdn.net/rongku/article/details/51336424</a></li>
<li>Shiro（4）默认鉴权与自定义鉴权 　　<a target="_blank" rel="noopener" href="http://blog.csdn.net/zhengwei223/article/details/9981741">http://blog.csdn.net/zhengwei223/article/details/9981741</a></li>
<li>拦截器机制-跟我学shiro 　　　　<a target="_blank" rel="noopener" href="http://jinnianshilongnian.iteye.com/blog/2025656">http://jinnianshilongnian.iteye.com/blog/2025656</a></li>
<li>shiro Filter–拦截器源码解释　　 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/yoohot/p/6085830.html">https://www.cnblogs.com/yoohot/p/6085830.html</a></li>
<li>动态URL　　 <a target="_blank" rel="noopener" href="http://blog.csdn.net/shadowsick/article/details/39001273">http://blog.csdn.net/shadowsick/article/details/39001273</a></li>
<li>重写shirofilterbean方式加载数据库资源权限　　 <a target="_blank" rel="noopener" href="http://blog.csdn.net/qq_18333833/article/details/70243620">http://blog.csdn.net/qq_18333833&#x2F;article&#x2F;details&#x2F;70243620</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/11/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Mybatis%20Generator%E6%9C%80%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/11/07/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Mybatis%20Generator%E6%9C%80%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Mybatis Generator最完整配置详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-11-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-07T00:00:00+08:00">2015-11-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>同学们有福了，花了一些时间，重新整理了一个最完整的Mybatis Generator（简称MBG）的最完整配置文件，带详解，再也不用去看EN的User Guide了；</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
  PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
"http://mybatis.org/dtd/mybatis-generator-config\_1\_0.dtd"\>
<!-- 配置生成器 \-->
<p>&lt;generatorConfiguration&gt;</p>
<!-- 可以用于加载配置项或者配置文件，在整个配置文件中就可以使用${propertyKey}的方式来引用配置项
    resource：配置资源加载地址，使用resource，MBG从classpath开始找，比如com/myproject/generatorConfig.properties        
    url：配置资源加载地质，使用URL的方式，比如file:///C:/myfolder/generatorConfig.properties.
    注意，两个属性只能选址一个;

    另外，如果使用了mybatis-generator-maven-plugin，那么在pom.xml中定义的properties都可以直接在generatorConfig.xml中使用
<properties resource="" url="" /> \-->

 <!-- 在MBG工作的时候，需要额外加载的依赖包
     location属性指明加载jar/zip包的全路径
<classPathEntry location="/Program Files/IBM/SQLLIB/java/db2java.zip" /> \-->

<!-- context:生成一组对象的环境 
    id:必选，上下文id，用于在生成错误时提示
    defaultModelType:指定生成对象的样式
        1，conditional：类似hierarchical；
        2，flat：所有内容（主键，blob）等全部生成在一个对象中；
        3，hierarchical：主键生成一个XXKey对象(key class)，Blob等单独生成一个对象，其他简单属性在一个对象中(record class)
    targetRuntime:
        1，MyBatis3：默认的值，生成基于MyBatis3.x以上版本的内容，包括XXXBySample；
        2，MyBatis3Simple：类似MyBatis3，只是不生成XXXBySample；
    introspectedColumnImpl：类全限定名，用于扩展MBG \-->
<p>&lt;context id=“mysql” defaultModelType=“hierarchical” targetRuntime=“MyBatis3Simple” &gt;</p>
<pre><code>&lt;!-- 自动识别数据库关键字，默认false，如果设置为true，根据SqlReservedWords中定义的关键字列表；
    一般保留默认值，遇到数据库关键字（Java关键字），使用columnOverride覆盖 \--&gt;
&lt;property name\=&quot;autoDelimitKeywords&quot; value\=&quot;false&quot;/&gt;
&lt;!-- 生成的Java文件的编码 \--&gt;
&lt;property name\=&quot;javaFileEncoding&quot; value\=&quot;UTF-8&quot;/&gt;
&lt;!-- 格式化java代码 \--&gt;
&lt;property name\=&quot;javaFormatter&quot; value\=&quot;org.mybatis.generator.api.dom.DefaultJavaFormatter&quot;/&gt;
&lt;!-- 格式化XML代码 \--&gt;
&lt;property name\=&quot;xmlFormatter&quot; value\=&quot;org.mybatis.generator.api.dom.DefaultXmlFormatter&quot;/&gt;

&lt;!-- beginningDelimiter和endingDelimiter：指明数据库的用于标记数据库对象名的符号，比如ORACLE就是双引号，MYSQL默认是\`反引号； \--&gt;
&lt;property name\=&quot;beginningDelimiter&quot; value\=&quot;\`&quot;/&gt;
&lt;property name\=&quot;endingDelimiter&quot; value\=&quot;\`&quot;/&gt;

&lt;!-- 必须要有的，使用这个配置链接数据库
    @TODO:是否可以扩展 \--&gt;
&lt;jdbcConnection driverClass\=&quot;com.mysql.jdbc.Driver&quot; connectionURL\=&quot;jdbc:mysql:///pss&quot; userId\=&quot;root&quot; password\=&quot;admin&quot;\&gt;
    &lt;!-- 这里面可以设置property属性，每一个property属性都设置到配置的Driver上 \--&gt;
&lt;/jdbcConnection\&gt;

&lt;!-- java类型处理器 
    用于处理DB中的类型到Java中的类型，默认使用JavaTypeResolverDefaultImpl；
    注意一点，默认会先尝试使用Integer，Long，Short等来对应DECIMAL和 NUMERIC数据类型； \--&gt;
&lt;javaTypeResolver type\=&quot;org.mybatis.generator.internal.types.JavaTypeResolverDefaultImpl&quot;\&gt;
    &lt;!-- true：使用BigDecimal对应DECIMAL和 NUMERIC数据类型
        false：默认,
            scale&gt;0;length&gt;18：使用BigDecimal;
            scale=0;length\[10,18\]：使用Long；
            scale=0;length\[5,9\]：使用Integer；
            scale=0;length&lt;5：使用Short； \--&gt;
    &lt;property name\=&quot;forceBigDecimals&quot; value\=&quot;false&quot;/&gt;
&lt;/javaTypeResolver\&gt;

&lt;!-- java模型创建器，是必须要的元素
    负责：1，key类（见context的defaultModelType）；2，java类；3，查询类
    targetPackage：生成的类要放的包，真实的包受enableSubPackages属性控制；
    targetProject：目标项目，指定一个存在的目录下，生成的内容会放到指定目录中，如果目录不存在，MBG不会自动建目录 \--&gt;
&lt;javaModelGenerator targetPackage\=&quot;com.\_520it.mybatis.domain&quot; targetProject\=&quot;src/main/java&quot;\&gt;
    &lt;!-- for MyBatis3/MyBatis3Simple
        自动为每一个生成的类创建一个构造方法，构造方法包含了所有的field；而不是使用setter； \--&gt;
    &lt;property name\=&quot;constructorBased&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 在targetPackage的基础上，根据数据库的schema再生成一层package，最终生成的类放在这个package下，默认为false \--&gt;
    &lt;property name\=&quot;enableSubPackages&quot; value\=&quot;true&quot;/&gt;

    &lt;!-- for MyBatis3 / MyBatis3Simple
        是否创建一个不可变的类，如果为true，
        那么MBG会创建一个没有setter方法的类，取而代之的是类似constructorBased的类 \--&gt;
    &lt;property name\=&quot;immutable&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 设置一个根对象，
        如果设置了这个根对象，那么生成的keyClass或者recordClass会继承这个类；在Table的rootClass属性中可以覆盖该选项
        注意：如果在key class或者record class中有root class相同的属性，MBG就不会重新生成这些属性了，包括：
            1，属性名相同，类型相同，有相同的getter/setter方法； \--&gt;
    &lt;property name\=&quot;rootClass&quot; value\=&quot;com.\_520it.mybatis.domain.BaseDomain&quot;/&gt;

    &lt;!-- 设置是否在getter方法中，对String类型字段调用trim()方法 \--&gt;
    &lt;property name\=&quot;trimStrings&quot; value\=&quot;true&quot;/&gt;
&lt;/javaModelGenerator\&gt;

&lt;!-- 生成SQL map的XML文件生成器，
    注意，在Mybatis3之后，我们可以使用mapper.xml文件+Mapper接口（或者不用mapper接口），
        或者只使用Mapper接口+Annotation，所以，如果 javaClientGenerator配置中配置了需要生成XML的话，这个元素就必须配置
    targetPackage/targetProject:同javaModelGenerator \--&gt;
&lt;sqlMapGenerator targetPackage\=&quot;com.\_520it.mybatis.mapper&quot; targetProject\=&quot;src/main/resources&quot;\&gt;
    &lt;!-- 在targetPackage的基础上，根据数据库的schema再生成一层package，最终生成的类放在这个package下，默认为false \--&gt;
    &lt;property name\=&quot;enableSubPackages&quot; value\=&quot;true&quot;/&gt;
&lt;/sqlMapGenerator\&gt;

&lt;!-- 对于mybatis来说，即生成Mapper接口，注意，如果没有配置该元素，那么默认不会生成Mapper接口 
    targetPackage/targetProject:同javaModelGenerator
    type：选择怎么生成mapper接口（在MyBatis3/MyBatis3Simple下）：
        1，ANNOTATEDMAPPER：会生成使用Mapper接口+Annotation的方式创建（SQL生成在annotation中），不会生成对应的XML；
        2，MIXEDMAPPER：使用混合配置，会生成Mapper接口，并适当添加合适的Annotation，但是XML会生成在XML中；
        3，XMLMAPPER：会生成Mapper接口，接口完全依赖XML；
    注意，如果context是MyBatis3Simple：只支持ANNOTATEDMAPPER和XMLMAPPER \--&gt;
&lt;javaClientGenerator targetPackage\=&quot;com.\_520it.mybatis.mapper&quot; type\=&quot;ANNOTATEDMAPPER&quot; targetProject\=&quot;src/main/java&quot;\&gt;
    &lt;!-- 在targetPackage的基础上，根据数据库的schema再生成一层package，最终生成的类放在这个package下，默认为false \--&gt;
    &lt;property name\=&quot;enableSubPackages&quot; value\=&quot;true&quot;/&gt;

    &lt;!-- 可以为所有生成的接口添加一个父接口，但是MBG只负责生成，不负责检查
    &lt;property name=&quot;rootInterface&quot; value=&quot;&quot;/&gt; \--&gt;
&lt;/javaClientGenerator\&gt;

&lt;!-- 选择一个table来生成相关文件，可以有一个或多个table，必须要有table元素
    选择的table会生成一下文件：
    1，SQL map文件
    2，生成一个主键类；
    3，除了BLOB和主键的其他字段的类；
    4，包含BLOB的类；
    5，一个用户生成动态查询的条件类（selectByExample, deleteByExample），可选；
    6，Mapper接口（可选）

    tableName（必要）：要生成对象的表名；
    注意：大小写敏感问题。正常情况下，MBG会自动的去识别数据库标识符的大小写敏感度，在一般情况下，MBG会
        根据设置的schema，catalog或tablename去查询数据表，按照下面的流程：
        1，如果schema，catalog或tablename中有空格，那么设置的是什么格式，就精确的使用指定的大小写格式去查询；
        2，否则，如果数据库的标识符使用大写的，那么MBG自动把表名变成大写再查找；
        3，否则，如果数据库的标识符使用小写的，那么MBG自动把表名变成小写再查找；
        4，否则，使用指定的大小写格式查询；
    另外的，如果在创建表的时候，使用的&quot;&quot;把数据库对象规定大小写，就算数据库标识符是使用的大写，在这种情况下也会使用给定的大小写来创建表名；
    这个时候，请设置delimitIdentifiers=&quot;true&quot;即可保留大小写格式；

    可选：
    1，schema：数据库的schema；
    2，catalog：数据库的catalog；
    3，alias：为数据表设置的别名，如果设置了alias，那么生成的所有的SELECT SQL语句中，列名会变成：alias\_actualColumnName
    4，domainObjectName：生成的domain类的名字，如果不设置，直接使用表名作为domain类的名字；可以设置为somepck.domainName，那么会自动把domainName类再放到somepck包里面；
    5，enableInsert（默认true）：指定是否生成insert语句；
    6，enableSelectByPrimaryKey（默认true）：指定是否生成按照主键查询对象的语句（就是getById或get）；
    7，enableSelectByExample（默认true）：MyBatis3Simple为false，指定是否生成动态查询语句；
    8，enableUpdateByPrimaryKey（默认true）：指定是否生成按照主键修改对象的语句（即update)；
    9，enableDeleteByPrimaryKey（默认true）：指定是否生成按照主键删除对象的语句（即delete）；
    10，enableDeleteByExample（默认true）：MyBatis3Simple为false，指定是否生成动态删除语句；
    11，enableCountByExample（默认true）：MyBatis3Simple为false，指定是否生成动态查询总条数语句（用于分页的总条数查询）；
    12，enableUpdateByExample（默认true）：MyBatis3Simple为false，指定是否生成动态修改语句（只修改对象中不为空的属性）；
    13，modelType：参考context元素的defaultModelType，相当于覆盖；
    14，delimitIdentifiers：参考tableName的解释，注意，默认的delimitIdentifiers是双引号，如果类似MYSQL这样的数据库，使用的是\`（反引号，那么还需要设置context的beginningDelimiter和endingDelimiter属性）
    15，delimitAllColumns：设置是否所有生成的SQL中的列名都使用标识符引起来。默认为false，delimitIdentifiers参考context的属性

    注意，table里面很多参数都是对javaModelGenerator，context等元素的默认属性的一个复写； \--&gt;
&lt;table tableName\=&quot;userinfo&quot; \&gt;

    &lt;!-- 参考 javaModelGenerator 的 constructorBased属性\--&gt;
    &lt;property name\=&quot;constructorBased&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 默认为false，如果设置为true，在生成的SQL中，table名字不会加上catalog或schema； \--&gt;
    &lt;property name\=&quot;ignoreQualifiersAtRuntime&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 参考 javaModelGenerator 的 immutable 属性 \--&gt;
    &lt;property name\=&quot;immutable&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 指定是否只生成domain类，如果设置为true，只生成domain类，如果还配置了sqlMapGenerator，那么在mapper XML文件中，只生成resultMap元素 \--&gt;
    &lt;property name\=&quot;modelOnly&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- 参考 javaModelGenerator 的 rootClass 属性 
    &lt;property name=&quot;rootClass&quot; value=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 参考javaClientGenerator 的  rootInterface 属性
    &lt;property name=&quot;rootInterface&quot; value=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 如果设置了runtimeCatalog，那么在生成的SQL中，使用该指定的catalog，而不是table元素上的catalog 
    &lt;property name=&quot;runtimeCatalog&quot; value=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 如果设置了runtimeSchema，那么在生成的SQL中，使用该指定的schema，而不是table元素上的schema 
    &lt;property name=&quot;runtimeSchema&quot; value=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 如果设置了runtimeTableName，那么在生成的SQL中，使用该指定的tablename，而不是table元素上的tablename 
    &lt;property name=&quot;runtimeTableName&quot; value=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 注意，该属性只针对MyBatis3Simple有用；
        如果选择的runtime是MyBatis3Simple，那么会生成一个SelectAll方法，如果指定了selectAllOrderByClause，那么会在该SQL中添加指定的这个order条件； \--&gt;
    &lt;property name\=&quot;selectAllOrderByClause&quot; value\=&quot;age desc,username asc&quot;/&gt;

    &lt;!-- 如果设置为true，生成的model类会直接使用column本身的名字，而不会再使用驼峰命名方法，比如BORN\_DATE，生成的属性名字就是BORN\_DATE,而不会是bornDate \--&gt;
    &lt;property name\=&quot;useActualColumnNames&quot; value\=&quot;false&quot;/&gt;

    &lt;!-- generatedKey用于生成生成主键的方法，
        如果设置了该元素，MBG会在生成的&lt;insert&gt;元素中生成一条正确的&lt;selectKey&gt;元素，该元素可选
        column:主键的列名；
        sqlStatement：要生成的selectKey语句，有以下可选项：
            Cloudscape:相当于selectKey的SQL为： VALUES IDENTITY\_VAL\_LOCAL()
            DB2       :相当于selectKey的SQL为： VALUES IDENTITY\_VAL\_LOCAL()
            DB2\_MF    :相当于selectKey的SQL为：SELECT IDENTITY\_VAL\_LOCAL() FROM SYSIBM.SYSDUMMY1
            Derby      :相当于selectKey的SQL为：VALUES IDENTITY\_VAL\_LOCAL()
            HSQLDB      :相当于selectKey的SQL为：CALL IDENTITY()
            Informix  :相当于selectKey的SQL为：select dbinfo(&#39;sqlca.sqlerrd1&#39;) from systables where tabid=1
            MySql      :相当于selectKey的SQL为：SELECT LAST\_INSERT\_ID()
            SqlServer :相当于selectKey的SQL为：SELECT SCOPE\_IDENTITY()
            SYBASE      :相当于selectKey的SQL为：SELECT @@IDENTITY
            JDBC      :相当于在生成的insert元素上添加useGeneratedKeys=&quot;true&quot;和keyProperty属性
    &lt;generatedKey column=&quot;&quot; sqlStatement=&quot;&quot;/&gt; \--&gt;

    &lt;!-- 该元素会在根据表中列名计算对象属性名之前先重命名列名，非常适合用于表中的列都有公用的前缀字符串的时候，
        比如列名为：CUST\_ID,CUST\_NAME,CUST\_EMAIL,CUST\_ADDRESS等；
        那么就可以设置searchString为&quot;^CUST\_&quot;，并使用空白替换，那么生成的Customer对象中的属性名称就不是
        custId,custName等，而是先被替换为ID,NAME,EMAIL,然后变成属性：id，name，email；

        注意，MBG是使用java.util.regex.Matcher.replaceAll来替换searchString和replaceString的，
        如果使用了columnOverride元素，该属性无效；

    &lt;columnRenamingRule searchString=&quot;&quot; replaceString=&quot;&quot;/&gt; \--&gt;

     &lt;!-- 用来修改表中某个列的属性，MBG会使用修改后的列来生成domain的属性；
         column:要重新设置的列名；
         注意，一个table元素中可以有多个columnOverride元素哈~ \--&gt;
     &lt;columnOverride column\=&quot;username&quot;\&gt;
         &lt;!-- 使用property属性来指定列要生成的属性名称 \--&gt;
         &lt;property name\=&quot;property&quot; value\=&quot;userName&quot;/&gt;

         &lt;!-- javaType用于指定生成的domain的属性类型，使用类型的全限定名
         &lt;property name=&quot;javaType&quot; value=&quot;&quot;/&gt; \--&gt;

         &lt;!-- jdbcType用于指定该列的JDBC类型 
         &lt;property name=&quot;jdbcType&quot; value=&quot;&quot;/&gt; \--&gt;

         &lt;!-- typeHandler 用于指定该列使用到的TypeHandler，如果要指定，配置类型处理器的全限定名
             注意，mybatis中，不会生成到mybatis-config.xml中的typeHandler
             只会生成类似：where id = #&#123;id,jdbcType=BIGINT,typeHandler=com.\_520it.mybatis.MyTypeHandler&#125;的参数描述
         &lt;property name=&quot;jdbcType&quot; value=&quot;&quot;/&gt; \--&gt;

         &lt;!-- 参考table元素的delimitAllColumns配置，默认为false
         &lt;property name=&quot;delimitedColumnName&quot; value=&quot;&quot;/&gt; \--&gt;
     &lt;/columnOverride\&gt;

     &lt;!-- ignoreColumn设置一个MGB忽略的列，如果设置了改列，那么在生成的domain中，生成的SQL中，都不会有该列出现 
         column:指定要忽略的列的名字；
         delimitedColumnName：参考table元素的delimitAllColumns配置，默认为false

         注意，一个table元素中可以有多个ignoreColumn元素
     &lt;ignoreColumn column=&quot;deptId&quot; delimitedColumnName=&quot;&quot;/&gt; \--&gt;
&lt;/table\&gt;
</code></pre>
<p>&lt;&#x2F;context&gt;</p>
<p>&lt;&#x2F;generatorConfiguration&gt;</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/11/02/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/11/02/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">单例模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-11-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-02T00:00:00+08:00">2015-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在软件开发中，<strong>单例模式（Singleton Pattern）</strong> 是一种常见的设计模式，用于确保一个类只有一个实例，并提供一个全局访问点。它适用于需要严格控制资源访问的场景，例如数据库连接池、配置管理器或任务调度器等。本文将详细介绍单例模式的核心思想，并展示其在 <strong>C#、Python、Golang、C 和 C++</strong> 中的实现方式。</p>
<p>单例模式的主要特点包括：</p>
<ul>
<li><strong>唯一性</strong>：类只有一个实例对象</li>
<li><strong>自创建</strong>：类自行创建自己的实例</li>
<li><strong>全局访问</strong>：提供一个全局访问点来获取该实例</li>
</ul>
<p>特点</p>
<ul>
<li><strong>唯一性</strong>：类自身负责创建和管理实例。</li>
<li><strong>延迟加载</strong>：实例通常在第一次使用时创建（懒汉式）。</li>
<li><strong>线程安全</strong>：在多线程环境中需确保实例的唯一性。</li>
<li><strong>不可克隆&#x2F;序列化</strong>：避免通过克隆或反序列化创建新实例。</li>
</ul>
<h2 id="单例模式的实现方式"><a href="#单例模式的实现方式" class="headerlink" title="单例模式的实现方式"></a>单例模式的实现方式</h2><h3 id="C-实现"><a href="#C-实现" class="headerlink" title="C# 实现"></a>C# 实现</h3><p>C# 中的单例模式通常通过 <strong>双重检查锁定（Double-Check Locking）</strong> 实现，以确保线程安全和延迟加载。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 使用 volatile 保证多线程下的可见性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton _instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> _lock = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 私有构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">GetInstance</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">	    <span class="comment">// 第一次检查，避免不必要的锁定</span></span><br><span class="line">        <span class="keyword">if</span> (_instance == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">			 <span class="comment">// 锁定操作</span></span><br><span class="line">            <span class="keyword">lock</span> (_lock)</span><br><span class="line">            &#123;</span><br><span class="line">				<span class="comment">// 第二次检查，确保多线程安全</span></span><br><span class="line">                <span class="keyword">if</span> (_instance == <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    _instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="饿汉式（立即加载）"><a href="#饿汉式（立即加载）" class="headerlink" title="饿汉式（立即加载）"></a>饿汉式（立即加载）</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 静态初始化，CLR保证线程安全</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Singleton _instance = <span class="keyword">new</span> Singleton();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 私有构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">GetInstance</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Python-实现"><a href="#Python-实现" class="headerlink" title="Python 实现"></a>Python 实现</h3><p>Python 的模块天然支持单例，但也可以通过类实现。以下是一个线程安全的懒汉式实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>:</span><br><span class="line">    _instance_lock = threading.Lock()  <span class="comment"># 线程锁</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 初始化逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(Singleton, <span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">            <span class="keyword">with</span> cls._instance_lock:  <span class="comment"># 确保线程安全</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(Singleton, <span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">                    Singleton._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        <span class="keyword">return</span> Singleton._instance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">s1 = Singleton()</span><br><span class="line">s2 = Singleton()</span><br><span class="line"><span class="built_in">print</span>(s1 <span class="keyword">is</span> s2)  <span class="comment"># 输出: True</span></span><br></pre></td></tr></table></figure>

<h4 id="饿汉式（模块级单例）"><a href="#饿汉式（模块级单例）" class="headerlink" title="饿汉式（模块级单例）"></a>饿汉式（模块级单例）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># singleton.py</span><br><span class="line">class Singleton:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">instance = Singleton()</span><br><span class="line"></span><br><span class="line"># 使用示例</span><br><span class="line">from singleton import instance</span><br></pre></td></tr></table></figure>

<h4 id="装饰器实现"><a href="#装饰器实现" class="headerlink" title="装饰器实现"></a>装饰器实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">singleton</span>(<span class="params">cls</span>): </span><br><span class="line">	instances = &#123;&#125; </span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>): </span><br><span class="line">		<span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> instances: </span><br><span class="line">			instances[cls] = cls(*args, **kwargs) </span><br><span class="line">			<span class="keyword">return</span> instances[cls]</span><br><span class="line">		<span class="keyword">return</span> wrapper </span><br><span class="line">		</span><br><span class="line"><span class="meta">@singleton </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySingleton</span>: </span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="Golang-实现"><a href="#Golang-实现" class="headerlink" title="Golang 实现"></a>Golang 实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Singleton <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	instance *Singleton</span><br><span class="line">	once     sync.Once</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInstance</span><span class="params">()</span></span> *Singleton &#123;</span><br><span class="line">	<span class="comment">// sync.Once 确保代码只执行一次，线程安全</span></span><br><span class="line">	once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		instance = &amp;Singleton&#123;&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s1 := GetInstance()</span><br><span class="line">	s2 := GetInstance()</span><br><span class="line">	<span class="built_in">println</span>(s1 == s2) <span class="comment">// 输出: true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">type Singleton struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">var instance = &amp;Singleton&#123;&#125;</span><br><span class="line"></span><br><span class="line">func GetInstance() *Singleton &#123;</span><br><span class="line">	return instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单例模式的优缺点"><a href="#单例模式的优缺点" class="headerlink" title="单例模式的优缺点"></a>单例模式的优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li><strong>控制实例数量</strong>：确保全局唯一性，避免资源浪费。</li>
<li><strong>灵活扩展</strong>：可通过子类化或组合模式扩展功能。</li>
<li><strong>全局访问</strong>：简化了对共享资源的访问。</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li><strong>违反单一职责原则</strong>：类负责管理自己的实例，增加了耦合。</li>
<li><strong>测试困难</strong>：全局状态可能导致单元测试难以隔离。</li>
<li><strong>生命周期管理</strong>：实例与程序生命周期一致，可能占用过多内存。.</li>
</ul>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><ul>
<li><strong>资源管理器</strong>：如文件系统、数据库连接池。</li>
<li><strong>配置中心</strong>：全局配置对象，避免重复加载配置。</li>
<li><strong>缓存服务</strong>：单点缓存，减少内存开销。</li>
<li><strong>日志记录器</strong>：统一日志输出，避免多线程冲突。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>单例模式是一种简单但强大的设计模式，适用于需要严格控制实例数量的场景。不同编程语言的实现方式各有特色：</p>
<ul>
<li><strong>C#</strong> 通过 <code>lock</code> 和 <code>volatile</code> 保证线程安全。</li>
<li><strong>Python</strong> 可利用模块的天然单例特性。</li>
<li><strong>Golang</strong> 使用 <code>sync.Once</code> 实现原子初始化。</li>
<li><strong>C&#x2F;C++</strong> 通过静态局部变量或互斥锁实现线程安全。</li>
</ul>
<p><strong>实现要点总结</strong>：</p>
<ol>
<li><strong>私有构造函数</strong>：防止外部直接实例化</li>
<li><strong>静态实例变量</strong>：保存唯一的实例</li>
<li><strong>全局访问点</strong>：提供获取实例的静态方法</li>
<li><strong>线程安全</strong>：在多线程环境下需要考虑线程安全问题</li>
</ol>
<p><strong>选择建议</strong>：</p>
<ul>
<li><strong>懒汉式</strong>：适用于实例创建开销较大，且可能不被使用的场景</li>
<li><strong>饿汉式</strong>：适用于实例创建开销小，且一定会被使用的场景</li>
<li><strong>双重检查锁定</strong>：适用于需要兼顾性能和线程安全的场景</li>
</ul>
<p>在实际开发中，需根据语言特性和具体需求选择合适的实现方式，同时注意避免过度使用单例模式，以免引入全局状态带来的复杂性。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/10/31/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Java&Quartz%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/10/31/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/Java&Quartz%E5%AE%9E%E7%8E%B0%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/" class="post-title-link" itemprop="url">Java&Quartz实现任务调度</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-10-31 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-31T00:00:00+08:00">2015-10-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-Quartz的作用"><a href="#1-Quartz的作用" class="headerlink" title="1.Quartz的作用"></a>1.Quartz的作用</h2><p>定时自动执行任务</p>
<h2 id="2-预备"><a href="#2-预备" class="headerlink" title="2.预备"></a>2.预备</h2><p>相关包<a target="_blank" rel="noopener" href="http://www.quartz-scheduler.org/">官方网站</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quartz2.2.1</span><br><span class="line">quartz-jobs2.2.1</span><br></pre></td></tr></table></figure>

<p>POM文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;quartz&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.2.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;quartz-jobs&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;2.2.1&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;   </span><br></pre></td></tr></table></figure>

<h2 id="3-Quartz核心"><a href="#3-Quartz核心" class="headerlink" title="3.Quartz核心"></a>3.Quartz核心</h2><h3 id="3-1-Job接口"><a href="#3-1-Job接口" class="headerlink" title="3.1.Job接口"></a>3.1.Job接口</h3><p>被调度的任务,只有一个方法execute(JobExecutionContext xontext),Job运行时的信息保存在JobDataMap中</p>
<h3 id="3-2-JobDetail类"><a href="#3-2-JobDetail类" class="headerlink" title="3.2.JobDetail类"></a>3.2.JobDetail类</h3><p>实现Job接口,用来描述Job的相关信息,包含Name,Group,JobDataMap等</p>
<h3 id="3-3-JobExecutionContext类"><a href="#3-3-JobExecutionContext类" class="headerlink" title="3.3 JobExecutionContext类"></a>3.3 JobExecutionContext类</h3><p>定时程序执行的run-time的上下文环境,用于得到Job的名字、配置的参数等</p>
<h3 id="3-3-JobDataMap类"><a href="#3-3-JobDataMap类" class="headerlink" title="3.3 JobDataMap类"></a>3.3 JobDataMap类</h3><p>用来描述一个作业的参数,参数可以为金和基本类型或者某个对象的引用</p>
<h3 id="3-3-JobListener接口"><a href="#3-3-JobListener接口" class="headerlink" title="3.3 JobListener接口"></a>3.3 JobListener接口</h3><p>监听作业状态</p>
<h3 id="3-3-TriggaerListener接口"><a href="#3-3-TriggaerListener接口" class="headerlink" title="3.3 TriggaerListener接口"></a>3.3 TriggaerListener接口</h3><p>监听触发器状态</p>
<h3 id="3-3-JobStore"><a href="#3-3-JobStore" class="headerlink" title="3.3 JobStore"></a>3.3 JobStore</h3><h3 id="3-3-Tigger抽象类"><a href="#3-3-Tigger抽象类" class="headerlink" title="3.3.Tigger抽象类"></a>3.3.Tigger抽象类</h3><p>触发器,描述执行Job的触发规则,有SimpleTrigger和CronTrigger两个子类</p>
<h4 id="3-3-1-SimpleTrigger类"><a href="#3-3-1-SimpleTrigger类" class="headerlink" title="3.3.1.SimpleTrigger类"></a>3.3.1.SimpleTrigger类</h4><p>继承自Trigger类,每隔xx毫秒&#x2F;秒执行一次,主要实现固定一次或者固定时间<code>周期类</code>任务的触发</p>
<h4 id="3-3-2-CronTrigger类"><a href="#3-3-2-CronTrigger类" class="headerlink" title="3.3.2.CronTrigger类"></a>3.3.2.CronTrigger类</h4><p>继承自Trigger类,使用Cron表达式,实现各种<code>复杂时间规则</code>调度方案,如每天的某个时间,或每周的某几天触发执行之类</p>
<h3 id="3-4-Calendar包"><a href="#3-4-Calendar包" class="headerlink" title="3.4.Calendar包"></a>3.4.Calendar包</h3><p>一些日历特定时间点的集合,包内包含以下几个类</p>
<h4 id="3-4-1-BaseCalendar类"><a href="#3-4-1-BaseCalendar类" class="headerlink" title="3.4.1 BaseCalendar类"></a>3.4.1 BaseCalendar类</h4><h4 id="3-4-2-AnnualCalendar类"><a href="#3-4-2-AnnualCalendar类" class="headerlink" title="3.4.2 AnnualCalendar类"></a>3.4.2 AnnualCalendar类</h4><p>排除每一年中指定的一天或者多天</p>
<h4 id="3-4-3-CalendarComparator类"><a href="#3-4-3-CalendarComparator类" class="headerlink" title="3.4.3 CalendarComparator类"></a>3.4.3 CalendarComparator类</h4><h4 id="3-4-4-CronCalendar类"><a href="#3-4-4-CronCalendar类" class="headerlink" title="3.4.4 CronCalendar类"></a>3.4.4 CronCalendar类</h4><p>使用表达式排除某时间段不执行</p>
<h4 id="3-4-5-DailyCalendar类"><a href="#3-4-5-DailyCalendar类" class="headerlink" title="3.4.5 DailyCalendar类"></a>3.4.5 DailyCalendar类</h4><p>指定的时间范围内每天不执行</p>
<h4 id="3-4-6-HolidayCalendar类"><a href="#3-4-6-HolidayCalendar类" class="headerlink" title="3.4.6 HolidayCalendar类"></a>3.4.6 HolidayCalendar类</h4><p>排除节假日</p>
<h4 id="3-4-7-MonthlyCalendar类"><a href="#3-4-7-MonthlyCalendar类" class="headerlink" title="3.4.7 MonthlyCalendar类"></a>3.4.7 MonthlyCalendar类</h4><p>配出月份中的数天</p>
<h4 id="3-4-8-WeeklyCalendar类"><a href="#3-4-8-WeeklyCalendar类" class="headerlink" title="3.4.8 WeeklyCalendar类"></a>3.4.8 WeeklyCalendar类</h4><p>排除没周中的一天或者多天</p>
<h3 id="3-5-Scheduler类"><a href="#3-5-Scheduler类" class="headerlink" title="3.5.Scheduler类"></a>3.5.Scheduler类</h3><p>任务调度器,代表一个Quartz独立容器。</p>
<p>Scheduler可以将JobDetail和Trigger绑定,当Trigger触发时,对应的Job就会被执行,Job和Trigger是1:n(一对多)的关系</p>
<h3 id="3-6Misfire类"><a href="#3-6Misfire类" class="headerlink" title="3.6Misfire类"></a>3.6Misfire类</h3><p>错误的任务,本该执行单没有执行的任务调度</p>
<h2 id="4-实现"><a href="#4-实现" class="headerlink" title="4.实现"></a>4.实现</h2><h3 id="1-单任务实现"><a href="#1-单任务实现" class="headerlink" title="1.单任务实现"></a>1.单任务实现</h3><p>1.定义一个任务,新建任务类继承自Job类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.quartz.Job;</span><br><span class="line">import org.quartz.JobExecutionContext;</span><br><span class="line">import org.quartz.JobExecutionException;</span><br><span class="line"></span><br><span class="line">public class DemoJob implements Job &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void execute(JobExecutionContext arg0) throws JobExecutionException &#123;</span><br><span class="line">System.out.println(new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.新建类执行这个任务(SimpleTrigger)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.quartz.DateBuilder;</span><br><span class="line">import org.quartz.JobBuilder;</span><br><span class="line">import org.quartz.JobDetail;</span><br><span class="line">import org.quartz.Scheduler;</span><br><span class="line">import org.quartz.SchedulerException;</span><br><span class="line">import org.quartz.SchedulerFactory;</span><br><span class="line">import org.quartz.SimpleScheduleBuilder;</span><br><span class="line">import org.quartz.Trigger;</span><br><span class="line">import org.quartz.TriggerBuilder;</span><br><span class="line">import org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"></span><br><span class="line">public class QuartzDemo &#123;</span><br><span class="line"></span><br><span class="line">public void simpleRun() throws SchedulerException &#123;</span><br><span class="line"></span><br><span class="line">SchedulerFactory factory = new StdSchedulerFactory();</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    Date runTime = DateBuilder.evenSecondDateAfterNow();  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JobDetail jobDetail = JobBuilder.newJob(DemoJob.class)</span><br><span class="line">.withIdentity(&quot;demo_job&quot;, &quot;demo_group&quot;)</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line">Trigger trigger = TriggerBuilder.newTrigger()</span><br><span class="line">.withIdentity(&quot;demo_trigger&quot;, &quot;demo_group&quot;)</span><br><span class="line"></span><br><span class="line">.startAt(new Date())</span><br><span class="line">.withSchedule(</span><br><span class="line">SimpleScheduleBuilder</span><br><span class="line">.simpleSchedule()</span><br><span class="line">.withIntervalInSeconds(1)</span><br><span class="line">.withRepeatCount(5)</span><br><span class="line">).build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Scheduler scheduler = factory.getScheduler();</span><br><span class="line"></span><br><span class="line">scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">System.out.println(jobDetail.getKey() + &quot; 运行在: &quot; + runTime);   </span><br><span class="line">scheduler.start();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">QuartzDemo demo = new QuartzDemo();</span><br><span class="line">try &#123;</span><br><span class="line">demo.simpleRun();</span><br><span class="line">&#125; catch (SchedulerException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-多任务实现"><a href="#2-多任务实现" class="headerlink" title="2.多任务实现"></a>2.多任务实现</h3><ol>
<li>测试任务类<br>新建两个DemoJonOne和DemoJobTwo,都实现Job接口,内容如下</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void execute(JobExecutionContext arg0) throws JobExecutionException &#123;</span><br><span class="line">System.out.println(new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date())+&quot; Runed &quot;+getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.新建QuartzUtil类,内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import org.quartz.Job;</span><br><span class="line">import org.quartz.JobBuilder;</span><br><span class="line">import org.quartz.JobDetail;</span><br><span class="line">import org.quartz.Scheduler;</span><br><span class="line">import org.quartz.SchedulerException;</span><br><span class="line">import org.quartz.SchedulerFactory;</span><br><span class="line">import org.quartz.SimpleScheduleBuilder;</span><br><span class="line">import org.quartz.Trigger;</span><br><span class="line">import org.quartz.TriggerBuilder;</span><br><span class="line">import org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"></span><br><span class="line">public class QuartzUtil &#123;</span><br><span class="line">private final static String JOB_GROUP_NAME = &quot;QUARTZ_JOBGROUP_NAME&quot;;</span><br><span class="line">private final static String TRIGGER_GROUP_NAME = &quot;QUARTZ_TRIGGERGROUP_NAME&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public static void addJob(String jobName, String triggerName, Class&lt;? extends Job&gt; jobClass, int seconds)</span><br><span class="line">throws SchedulerException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SchedulerFactory sf = new StdSchedulerFactory();</span><br><span class="line"></span><br><span class="line">Scheduler sche = sf.getScheduler();</span><br><span class="line"></span><br><span class="line">JobDetail jobDetail = JobBuilder.newJob(jobClass).withIdentity(jobName, JOB_GROUP_NAME).build();</span><br><span class="line"></span><br><span class="line">Trigger trigger = TriggerBuilder.newTrigger()</span><br><span class="line">.withIdentity(triggerName, TRIGGER_GROUP_NAME)</span><br><span class="line">.startNow()</span><br><span class="line">.withSchedule(</span><br><span class="line">SimpleScheduleBuilder</span><br><span class="line">.simpleSchedule()</span><br><span class="line">.withIntervalInSeconds(seconds)</span><br><span class="line">.repeatForever()</span><br><span class="line">).build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sche.scheduleJob(jobDetail, trigger);</span><br><span class="line"></span><br><span class="line">sche.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">try &#123;</span><br><span class="line"></span><br><span class="line">QuartzUtil.addJob(&quot;job1&quot;, &quot;trigger1&quot;, DemoJobOne.class, 2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">QuartzUtil.addJob(&quot;Job2&quot;, &quot;trigger2&quot;, DemoJobTwo.class, 5);</span><br><span class="line">&#125; catch (SchedulerException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上方法属于手动调用,如果是web项目中就不同了<br>添加POM</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;servlet-api&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package servlet;</span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.http.HttpServlet;</span><br><span class="line"></span><br><span class="line">import org.quartz.SchedulerException;</span><br><span class="line"></span><br><span class="line">import com.DemoJobOne;</span><br><span class="line">import com.DemoJobTwo;</span><br><span class="line">import com.QuartzUtil;</span><br><span class="line"></span><br><span class="line">public class InitServlet extends HttpServlet &#123;</span><br><span class="line"></span><br><span class="line">private static final long serialVersionUID = 8507188690597926975L;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public void init() throws ServletException &#123;</span><br><span class="line">try &#123;</span><br><span class="line"></span><br><span class="line">QuartzUtil.addJob(&quot;job1&quot;, &quot;trigger1&quot;, DemoJobOne.class, 2);</span><br><span class="line"></span><br><span class="line">QuartzUtil.addJob(&quot;Job2&quot;, &quot;trigger2&quot;, DemoJobTwo.class, 5);</span><br><span class="line">&#125; catch (SchedulerException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.注册servlet</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;</span><br><span class="line">  &lt;servlet-name&gt;InitServlet&lt;/servlet-name&gt;</span><br><span class="line">  &lt;servlet-class&gt;servlet.InitServlet&lt;/servlet-class&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;load-on-startup&gt;0&lt;/load-on-startup&gt;</span><br><span class="line">&lt;/servlet&gt;</span><br><span class="line"></span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">  &lt;servlet-name&gt;InitServlet&lt;/servlet-name&gt;</span><br><span class="line">  &lt;url-pattern&gt;/InitServlet&lt;/url-pattern&gt;</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-复杂规则任务调度-CronTrigger"><a href="#3-复杂规则任务调度-CronTrigger" class="headerlink" title="3.复杂规则任务调度(CronTrigger)"></a>3.复杂规则任务调度(CronTrigger)</h3><p>在每分钟的1-30秒执行示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import org.quartz.CronScheduleBuilder;</span><br><span class="line">import org.quartz.JobBuilder;</span><br><span class="line">import org.quartz.JobDetail;</span><br><span class="line">import org.quartz.Scheduler;</span><br><span class="line">import org.quartz.SchedulerException;</span><br><span class="line">import org.quartz.SchedulerFactory;</span><br><span class="line">import org.quartz.Trigger;</span><br><span class="line">import org.quartz.TriggerBuilder;</span><br><span class="line">import org.quartz.impl.StdSchedulerFactory;</span><br><span class="line"></span><br><span class="line">public class CronTriggerDemo &#123;</span><br><span class="line">public static void main(String[] args) throws SchedulerException &#123;</span><br><span class="line"></span><br><span class="line">SchedulerFactory factory = new StdSchedulerFactory();</span><br><span class="line">Scheduler scheduler = factory.getScheduler();</span><br><span class="line"></span><br><span class="line">JobDetail job = JobBuilder</span><br><span class="line">.newJob(DemoJobOne.class)</span><br><span class="line">.withIdentity(&quot;job&quot;,&quot;group&quot;)</span><br><span class="line">.build();</span><br><span class="line"></span><br><span class="line">Trigger trigger = TriggerBuilder</span><br><span class="line">.newTrigger()</span><br><span class="line">.withIdentity(&quot;trigger&quot;, &quot;group&quot;)</span><br><span class="line">.startNow().withSchedule(</span><br><span class="line">CronScheduleBuilder</span><br><span class="line">.cronSchedule(&quot;1-30 * * * * ?&quot;)</span><br><span class="line">).build();</span><br><span class="line"></span><br><span class="line">scheduler.scheduleJob(job,trigger);</span><br><span class="line">scheduler.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-Cron表达式"><a href="#5-Cron表达式" class="headerlink" title="5.Cron表达式"></a>5.Cron表达式</h2><h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3><p>格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s M h d m w [y]</span><br></pre></td></tr></table></figure>

<p>s:seconds,取值0-59,允许- * &#x2F;;</p>
<p>M:minutes,取值0-59,允许- * &#x2F;;</p>
<p>h:hour,取值0-23,允许- * &#x2F;;</p>
<p>d:day of month,取值1-31,允许- * ? &#x2F; L W;</p>
<p>m:month,取值1-12&#x2F;JAN-DEC,允许- * &#x2F;;</p>
<p>w:day of week,取值1-7&#x2F;SUN-SAT,允许- * ? &#x2F; L #;</p>
<p>y:year,可选,取值empty、1970-2099,允许- * &#x2F;;</p>
<h3 id="符号解释"><a href="#符号解释" class="headerlink" title="符号解释"></a>符号解释</h3><p>、 指定枚举值,如在秒字段使用10、12,则表示只有第10秒和第12秒执行<br>- 指定区间范围,配合使用,如在小时字段使用10-12,表示在10、11、12时都会触发</p>
<p>* 代表所有值,单独使用,如在秒字段使用,表示每秒触发</p>
<p>? 代表不确定值,单独使用,不用关心的值</p>
<p>&#x2F; 用于递增触发,配合使用,n&#x2F;m,从n开始,每次增加m,如在秒字段设置5&#x2F;15,表示从第5秒开始,每15秒触发一次</p>
<p>L 表示最后,单独使用,如在秒字段使用,代表第59秒触发,如果在前面加上数字,则表示该数据的最后一个,如在周字段使用6L,则表示本月最后一个周五<br>W 表示最近的工作日,不会跨月,比如30W，30号是周六，则不会顺延至下周一来执行,如在月字段使用15W,则表示到本月15日最近的工作日(周一到周五)<br># 用来指定x的第n个工作日,如在周字段使用6#3则表示该月的第三个星期五</p>
<h3 id="月取值"><a href="#月取值" class="headerlink" title="月取值"></a>月取值</h3><p>一月:JAN&#x2F;0<br>二月:FEB&#x2F;1<br>三月:MAR&#x2F;2<br>四月:APR&#x2F;3<br>五月:MAY&#x2F;4<br>六月:JUN&#x2F;5<br>七月:JUL&#x2F;6<br>八月:AUG&#x2F;7<br>九月:SEP&#x2F;8<br>十月:OCT&#x2F;9<br>十一月:NOV&#x2F;10<br>十二月:DEC&#x2F;11</p>
<h3 id="周取值"><a href="#周取值" class="headerlink" title="周取值"></a>周取值</h3><p>周日:SUN&#x2F;1<br>周一:MON&#x2F;2<br>周二:TUE&#x2F;3<br>周三:WED&#x2F;4<br>周四:THU&#x2F;5<br>周五:FRI&#x2F;6<br>周六:SAT&#x2F;7</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0/20 * * * * ? 每20秒执行一次</span><br><span class="line">1-30 * * * * ? 在1-30秒执行</span><br><span class="line">15 0/2 * * * ? 偶数分钟的第15秒执行</span><br><span class="line">0 0/2 8-17 * * ? 从8时到17时 ,每个偶数分钟执行一次</span><br><span class="line">0 0/3 17-23 * * ? 从17时到23时,每3分钟运行一次</span><br><span class="line">0 0 10am 1,15 * ? 每个月的1号和15号的上午10点 运行</span><br><span class="line">0,30 * * ? * MON-FRI 周一至周五,每30秒运行一次</span><br><span class="line">0,30 * * ? * SAT,SUN 周六、周日,每30秒运行一次</span><br><span class="line">0 0 12 * * ? 每天12点触发</span><br><span class="line">0 15 10 ? * * 每天10点15分触发</span><br><span class="line">0 15 10 * * ? 每天10点15分触发</span><br><span class="line">0 15 10 * * ? * 每天10点15分触发</span><br><span class="line">0 15 10 * * ? 2005 2005年每天10点15分触发</span><br><span class="line">0 * 14 * * ? 每天下午的 2点到2点59分每分触发</span><br><span class="line">0 0/5 14 * * ? 每天下午的 2点到2点59分(整点开始，每隔5分触发)</span><br><span class="line">0 0/5 14,18 * * ? 每天下午的 2点到2点59分(整点开始，每隔5分触发) 每天下午的 18点到18点59分(整点开始，每隔5分触发)</span><br><span class="line">0 0-5 14 * * ?  每天下午的 2点到2点05分每分触发</span><br><span class="line">0 10,44 14 ? 3 WED 3月分每周三下午的 2点10分和2点44分触发</span><br><span class="line">0 15 10 ? * MON-FRI 从周一到周五每天上午的10点15分触发</span><br><span class="line">0 15 10 15 * ? 每月15号上午10点15分触发</span><br><span class="line">0 15 10 L * ? 每月最后一天的10点15分触发</span><br><span class="line">0 15 10 ? * 6L 每月最后一周的星期五的10点15分触发</span><br><span class="line">0 15 10 ? * 6L 2002-2005 从2002年到2005年每月最后一周的星期五的10点15分触发</span><br><span class="line">0 15 10 ? * 6#3 每月的第三周的星期五开始触发</span><br><span class="line">0 0 12 1/5 * ? 每月的第一个中午开始每隔5天触发一次</span><br><span class="line">0 11 11 11 11 ? 每年的11月11号 11点11分触发(光棍节)</span><br></pre></td></tr></table></figure>

<h2 id="6-Spring整合Quartz"><a href="#6-Spring整合Quartz" class="headerlink" title="6.Spring整合Quartz"></a>6.Spring整合Quartz</h2><p>需要Spring-context-support包支持,POM如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.3.5.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>新建两种Job测试类–&gt;DemoSimpleJob类和DemoCronJob类,并继承自QuartzJobBean,代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.quartz.JobExecutionContext;</span><br><span class="line">import org.quartz.JobExecutionException;</span><br><span class="line">import org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line">public class DemoJob extends QuartzJobBean &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void executeInternal(JobExecutionContext arg0) throws JobExecutionException &#123;</span><br><span class="line">        System.out.println(new SimpleDateFormat(&quot;hh:mm:ss&quot;).format(new Date()) + &quot; 输出自:&quot; + getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置spring bean如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">       http://www.springframework.org/schema/beans/spring-beans-4.3.xsd</span><br><span class="line">       http://www.springframework.org/schema/context</span><br><span class="line">       http://www.springframework.org/schema/context/spring-context-4.3.xsd</span><br><span class="line">       http://www.springframework.org/schema/aop</span><br><span class="line">       http://www.springframework.org/schema/aop/spring-aop-4.3.xsd</span><br><span class="line">       http://www.springframework.org/schema/tx</span><br><span class="line">       http://www.springframework.org/schema/tx/spring-tx-4.3.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &lt;bean id=&quot;demoCronJob&quot;</span><br><span class="line">        class=&quot;org.springframework.scheduling.quartz.JobDetailFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;jobClass&quot; value=&quot;com.DemoCronJob&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;demoSimpleJob&quot;</span><br><span class="line">        class=&quot;org.springframework.scheduling.quartz.JobDetailFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;jobClass&quot; value=&quot;com.DemoSimpleJob&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &lt;bean id=&quot;simpleTrigger&quot;</span><br><span class="line">        class=&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;jobDetail&quot; ref=&quot;demoSimpleJob&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;startDelay&quot; value=&quot;1000&quot; /&gt;  </span><br><span class="line">        &lt;property name=&quot;repeatInterval&quot; value=&quot;2000&quot; /&gt;  </span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;cornTrigger&quot;</span><br><span class="line">        class=&quot;org.springframework.scheduling.quartz.CronTriggerFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;jobDetail&quot; ref=&quot;demoCronJob&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;cronExpression&quot; value=&quot;1-30 * * * * ?&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;bean class=&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;triggers&quot;&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;ref bean=&quot;cornTrigger&quot; /&gt;</span><br><span class="line">                &lt;ref bean=&quot;simpleTrigger&quot; /&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line">public class Demo &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>有待补充</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/10/24/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/C#%E4%BD%BF%E7%94%A8EmguCV%E5%AE%9E%E7%8E%B0%E8%A7%86%E9%A2%91%E8%AF%BB%E5%8F%96%E5%92%8C%E6%92%AD%E6%94%BE%EF%BC%8C%E5%8F%8A%E5%A4%9A%E4%B8%AA%E8%A7%86%E9%A2%91%E4%B8%80%E8%B5%B7%E6%92%AD%E6%94%BE%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/10/24/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/C#%E4%BD%BF%E7%94%A8EmguCV%E5%AE%9E%E7%8E%B0%E8%A7%86%E9%A2%91%E8%AF%BB%E5%8F%96%E5%92%8C%E6%92%AD%E6%94%BE%EF%BC%8C%E5%8F%8A%E5%A4%9A%E4%B8%AA%E8%A7%86%E9%A2%91%E4%B8%80%E8%B5%B7%E6%92%AD%E6%94%BE%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">C#使用EmguCV实现视频读取和播放，及多个视频一起播放的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-10-24 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-24T00:00:00+08:00">2015-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/" itemprop="url" rel="index"><span itemprop="name">DotNet</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>WinForm程序</li>
</ol>
<p>1）第一种方法，使用委托：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">SetTextCallback</span>(<span class="params"><span class="built_in">string</span> text</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetText</span>(<span class="params"><span class="built_in">string</span> text</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// InvokeRequired需要比较调用线程ID和创建线程ID</span></span><br><span class="line">    <span class="comment">// 如果它们不相同则返回true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.txt_Name.InvokeRequired)</span><br><span class="line">    &#123;</span><br><span class="line">        SetTextCallback d = <span class="keyword">new</span> SetTextCallback(SetText);</span><br><span class="line">        <span class="keyword">this</span>.Invoke(d, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; text &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.txt_Name.Text = text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2）第二种方法，使用匿名委托</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetText</span>(<span class="params">Object obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.InvokeRequired)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.Invoke(<span class="keyword">new</span> MethodInvoker(<span class="built_in">delegate</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.txt_Name.Text = obj;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.txt_Name.Text = obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里说一下BeginInvoke和Invoke和区别：BeginInvoke会立即返回，Invoke会等执行完后再返回。</p>
<ol start="2">
<li>WPF程序</li>
</ol>
<p>1）可以使用Dispatcher线程模型来修改</p>
<p>如果是窗体本身可使用类似如下的代码：</p>
<p>this.lblState.Dispatcher.Invoke(new Action(delegate<br>{<br>     this.lblState.Content &#x3D; “状态：” + this._statusText;<br>}));</p>
<p>那么假如是在一个公共类中弹出一个窗口、播放声音等呢？这里我们可以使用：System.Windows.Application.Current.Dispatcher，如下所示</p>
<p><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p> System.Windows.Application.Current.Dispatcher.Invoke(new Action(() &#x3D;&gt;<br> {<br>     if (path.EndsWith(“.mp3”) || path.EndsWith(“.wma”) || path.EndsWith(“.wav”))<br>     {<br>        _player.Open(new Uri(path));<br>        _player.Play();<br>    }<br> }));</p>
<p><strong>关键问题：多个视频同时播放，以上几种方法不足以解决，多个视频播放中主界面卡死和播放显示刷新不了的问题。</strong></p>
<p>目前笔者的解决方法是</p>
<p> pinturebox.CreateGraphics().DrawImage(imgSrc.Bitmap, new System.Drawing.Rectangle(0, 0, pinturebox.Width, pinturebox.Height));</p>
<p>EmguCV中的Capture类可以完成视频文件的读取，并捕捉每一帧，可以利用Capture类完成实现WinForm中视频检测跟踪环境的搭建。本文只实现最简陋的WinForm + EmguCV上的avi文件读取和播放框架，复杂的检测和跟踪算法在之后添加进去。</p>
<p>        这里使用WinForm实现视频的播放，主要是PictureBox类，它是支持基于事件的异步模式的典型组件，不使用EmguCV自带的UI控件等。</p>
<p><img src="/%22%22" alt="效果图"></p>
<p>图1.效果图</p>
<p>        直接在UI线程中完成视频的播放的话整个程序只有一个线程，由于程序只能同步执行，播放视频的时候UI将停止响应用户的输入，造成界面的假死。所以视频的播放需要实现异步模式。主要有三种方法：第一是使用异步委托；第二种是使用BackgroundWorker组件；最后一种就是使用多线程（不使用CheckForIllegalCrossThreadCalls &#x3D;false的危险做法）。</p>
<p>        Windows窗体控件，唯一可以从创建它的线程之外的线程中调用的是Invoke()、BegionInvoke()、EndInvoke()方法和InvokeRequired属性。其中BegionInvoke()、EndInvoke()方法是Invoke()方法的异步版本。这些方法会切换到创建控件的线程上，以调用赋予一个委托参数的方法，该委托参数可以传递给这些方法。</p>
<p>        （一）   使用多线程<br>        首先定义监控的类及其对应的事件参数类和异常类：<br>        判断是否继续执行的布尔型成员会被调用线程改变，因此声名为volatile，不进行优化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 红外检测子。</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">public class ThermalSurveillant</span><br><span class="line">&#123;</span><br><span class="line">    #region Private Fields</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 是否停止线程，此变量供多个线程访问。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    private volatile bool shouldStop = false;</span><br><span class="line"> </span><br><span class="line">    #endregion</span><br><span class="line">    #region Public Properties</span><br><span class="line"> </span><br><span class="line">    #endregion</span><br><span class="line">    #region Public Events</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 帧刷新事件。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public EventHandler&lt;FrameRefreshEventArgs&gt; FrameRefresh;</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 播放完成。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public EventHandler&lt;CompletedEventArgs&gt; Completed;</span><br><span class="line"> </span><br><span class="line">    #endregion</span><br><span class="line">    #region Protected Methods</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 处理帧刷新事件。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;</span><br><span class="line">    protected virtual void OnFrameRefresh(FrameRefreshEventArgs e)</span><br><span class="line">    &#123;</span><br><span class="line">        if (this.FrameRefresh != null)</span><br><span class="line">        &#123;</span><br><span class="line">            this.FrameRefresh(this, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 处理视频读完事件。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;</span><br><span class="line">    protected virtual void OnCompleted(CompletedEventArgs e)</span><br><span class="line">    &#123;</span><br><span class="line">        if (this.Completed != null)</span><br><span class="line">        &#123;</span><br><span class="line">            this.Completed(this, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    #endregion</span><br><span class="line">    #region Public Methods</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 视频监控。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    /// &lt;param name=&quot;capture&quot;&gt;捕捉。&lt;/param&gt;</span><br><span class="line">    public void DoSurveillance(Object oCapture)</span><br><span class="line">    &#123;</span><br><span class="line">        Capture capture = oCapture as Capture;</span><br><span class="line">        int id = 1;</span><br><span class="line">        if (capture == null)</span><br><span class="line">        &#123;</span><br><span class="line">            throw new InvalidCaptureObjectException(&quot;传递的Capture类型无效。&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        while (!shouldStop)</span><br><span class="line">        &#123;</span><br><span class="line">            Image&lt;Bgr, byte&gt; frame = capture.QueryFrame();</span><br><span class="line">            if (frame != null)</span><br><span class="line">            &#123;</span><br><span class="line">                FrameRefreshEventArgs e = new FrameRefreshEventArgs(frame.ToBitmap(), id++);</span><br><span class="line">                // 触发刷新事件</span><br><span class="line">                this.OnFrameRefresh(e);</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 触发完成事件</span><br><span class="line">        this.OnCompleted(new CompletedEventArgs(id));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    /// &lt;summary&gt;</span><br><span class="line">    /// 请求停止线程。</span><br><span class="line">    /// &lt;/summary&gt;</span><br><span class="line">    public void Cancel()</span><br><span class="line">    &#123;</span><br><span class="line">        this.shouldStop = true;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    #endregion</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>        UI线程中启动播放线程：</p>
<p>声明：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监控线程。 </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> Thread threadSurveillance = <span class="literal">null</span>; </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 捕获视频帧。 </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> Capture captureSurveillance; </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 监控子。 </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> ThermalSurveillant surveillant = <span class="keyword">new</span> ThermalSurveillant();</span><br></pre></td></tr></table></figure>







<p>读入视频文件：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">captureSurveillance = <span class="keyword">new</span> Capture(<span class="keyword">this</span>.videoFilePath);</span><br><span class="line">captureSurveillance.SetCaptureProperty(CAP_PROP.CV_CAP_PROP_FRAME_WIDTH, <span class="keyword">this</span>.width);</span><br><span class="line">captureSurveillance.SetCaptureProperty(CAP_PROP.CV_CAP_PROP_FRAME_HEIGHT, <span class="keyword">this</span>.height);</span><br><span class="line">Image&lt;Bgr, <span class="built_in">byte</span>&gt; frame = captureSurveillance.QueryFrame();</span><br><span class="line"><span class="keyword">this</span>.pictureBox.Image = frame.ToBitmap();</span><br></pre></td></tr></table></figure>

<p>播放视频文件：</p>
<p>        UI线程中响应监控类的事件：</p>
<p>定义异步调用的委托：</p>
<p>添加事件委托：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.surveillant.FrameRefresh += OnRefreshFrame;</span><br><span class="line"><span class="keyword">this</span>.surveillant.Completed += OnCompleted;</span><br></pre></td></tr></table></figure>





<p>        以下方法中都是由监控线程中的事件委托方法，应该使用BeginInvoke方法，这样可以优雅的结束线程，如果使用Invoke方法，则调用方式为同步调用，此时如果使用Thread.Join()方法终止线程将引发死锁（正常播放没有问题），Thread.Join()方法的使用使调用线程阻塞等待当前线程完成，在这里即UI线程阻塞等待监控线程完成，而监控线程中又触发UI线程中pictureBox的刷新，使用Invoke方法就造成了监控线程等待UI线程刷新结果，而UI线程已经阻塞，形成了死锁。死锁时只能用Thread.Abort()方法才能结束线程。或者直接强制结束应用程序。</p>
<p>        使用BeginInvoke方法时为异步调用，监控线程不等待刷新结果直接继续执行，可以正常结束。结束后UI才进行刷新，不会造成死锁。</p>
<p><img src="/%22%22"></p>
<p>图2.线程关系</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 刷新UI线程的pixtureBox的方法。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;frame&quot;&gt;</span>要刷新的帧。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RefreshFrame</span>(<span class="params">Bitmap frame</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.pictureBox.Image = frame;</span><br><span class="line">    <span class="comment">// 这里一定不能刷新！2012年8月2日1:50:16</span></span><br><span class="line">    <span class="comment">//this.pictureBox.Refresh();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应pictureBox刷新。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnRefreshFrame</span>(<span class="params"><span class="built_in">object</span> sender, FrameRefreshEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 判断是否需要跨线程调用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pictureBox.InvokeRequired == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        FrameRefreshDelegate fresh = <span class="keyword">this</span>.RefreshFrame;</span><br><span class="line">        <span class="keyword">this</span>.BeginInvoke(fresh, e.Frame);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.RefreshFrame(e.Frame);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 响应Label刷新信息。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnCompleted</span>(<span class="params"><span class="built_in">object</span> sender, CompletedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 判断是否需要跨线程调用</span></span><br><span class="line">    CompletedDelegate fresh = <span class="keyword">this</span>.RefreshStatus;</span><br><span class="line">    <span class="built_in">string</span> message = <span class="string">&quot;视频结束，共 &quot;</span> + e.FrameCount + <span class="string">&quot; 帧。&quot;</span>;</span><br><span class="line">    <span class="keyword">this</span>.BeginInvoke(fresh, message);</span><br><span class="line">&#125;</span><br><span class="line">　　</span><br><span class="line"></span><br><span class="line">        关闭时需要中止播放线程之后再退出：</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 关闭窗体时发生。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnFormClosed</span>(<span class="params"><span class="built_in">object</span> sender, FormClosedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 检测子算法请求终止</span></span><br><span class="line">    surveillant.Cancel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞调用线程直到检测子线程终止</span></span><br><span class="line">    <span class="keyword">if</span> (threadSurveillance != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (threadSurveillance.IsAlive == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            threadSurveillance.Join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>        （二）   使用异步委托</p>
<p>        创建线程的一个更简单的方法是定义一个委托，并异步调用它。委托是方法的类型安全的引用。Delegate类还支持异步地调用方法。在后台，Delegate类会创建一个执行任务的线程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// asynchronous by using a delegate</span><br><span class="line">PlayVideoDelegate play = this.PlayVideoFile;</span><br><span class="line">IAsyncResult status = play.BeginInvoke(null, null);</span><br><span class="line"> </span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 播放视频文件。</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">private void PlayVideoFile()</span><br><span class="line">&#123;</span><br><span class="line">    while (true)</span><br><span class="line">    &#123;</span><br><span class="line">        Image&lt;Bgr, byte&gt; frame = capture.QueryFrame();</span><br><span class="line">        if (frame != null)</span><br><span class="line">        &#123;</span><br><span class="line">            Image&lt;Gray, byte&gt; grayFrame = frame.Convert&lt;Gray, byte&gt;();</span><br><span class="line">            grayFrame.Resize(this.width, this.height, INTER.CV_INTER_CUBIC);</span><br><span class="line">            RefreshPictureBoxDelegate fresh = this.RefreshPictureBox;</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                this.BeginInvoke(fresh, grayFrame.ToBitmap());</span><br><span class="line">            &#125;</span><br><span class="line">            catch (ObjectDisposedException ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Thread.CurrentThread.Abort();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 刷新UI线程的pixtureBox的方法。</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;param name=&quot;frame&quot;&gt;要刷新的帧。&lt;/param&gt;</span><br><span class="line">private void RefreshPictureBox(Bitmap frame)</span><br><span class="line">&#123;</span><br><span class="line">    this.pictureBox.Image = frame;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>        （三）   使用BackgroundWorker组件</p>
<p>        BackgroundWorker类是异步事件的一种实现方案，异步组件可以选择性的支持取消操作，并提供进度信息。RunWorkerAsync()方法启动异步调用。CancelAsync()方法取消。</p>
<p><img src="/%22%22"></p>
<p>图3.BackgroundWorker组件</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 播放视频文件。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">detectItemPlay_Click</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.videoFilePath != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// run async</span></span><br><span class="line">        <span class="keyword">this</span>.backgroundWorker.RunWorkerAsync(capture);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 异步调用。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnDoWork</span>(<span class="params"><span class="built_in">object</span> sender, DoWorkEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Emgu.CV.Capture capture = e.Argument <span class="keyword">as</span> Emgu.CV.Capture;</span><br><span class="line">    <span class="keyword">while</span> (!e.Cancel)</span><br><span class="line">    &#123;</span><br><span class="line">        Image&lt;Bgr, <span class="built_in">byte</span>&gt; frame = capture.QueryFrame();</span><br><span class="line">        <span class="keyword">if</span> (frame != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Image&lt;Gray, <span class="built_in">byte</span>&gt; grayFrame = frame.Convert&lt;Gray, <span class="built_in">byte</span>&gt;();</span><br><span class="line">            grayFrame.Resize(<span class="keyword">this</span>.width, <span class="keyword">this</span>.height, INTER.CV_INTER_CUBIC);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.backgroundWorker.CancellationPending == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                e.Cancel = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.pictureBox.InvokeRequired == <span class="literal">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    RefreshPictureBoxDelegate fresh = <span class="keyword">this</span>.RefreshPictureBox;</span><br><span class="line">                    <span class="keyword">this</span>.BeginInvoke(fresh, grayFrame.ToBitmap());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.RefreshPictureBox(grayFrame.ToBitmap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 关闭窗体时发生。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sender&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;e&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">MainForm_FormClosed</span>(<span class="params"><span class="built_in">object</span> sender, FormClosedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.backgroundWorker.IsBusy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.backgroundWorker.CancelAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chengming0916.github.io/2015/10/17/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%9C%A8%20WPF%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20Path%20%E8%B7%AF%E5%BE%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Chemmy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Chemmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/10/17/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/%E5%9C%A8%20WPF%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20Path%20%E8%B7%AF%E5%BE%84/" class="post-title-link" itemprop="url">在 WPF 中使用 Path 路径</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-10-17 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-17T00:00:00+08:00">2015-10-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-09-08 10:40:23" itemprop="dateModified" datetime="2025-09-08T10:40:23+08:00">2025-09-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">编程技术</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF/DotNet/" itemprop="url" rel="index"><span itemprop="name">DotNet</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在 WPF 中总会修改 Button 的 Style，比如一个自定义的 Close 按钮。刚入门的可能会用一张 PNG 格式的图片来做这个按钮的 Icon，但这个是不优雅的。而且你要改的时候还得去操作文件，想想都痛苦。</p>
<p>但是很多人苦于不知道去哪里获取 Path，当然网上已经有不少使用 Photoshop 获取图片的 Path ，但如果图片的质量不好，获取的 Path 歪歪曲曲的也不好看，更何况在这之前你还得会使用 Photoshop。</p>
<p>现在分享一个我经常使用的解决方案，<a target="_blank" rel="noopener" href="http://www.iconfont.cn/">阿里巴巴矢量图</a>，这上面可以说有海量的图标可以用到。</p>
<p>流程：</p>
<p>　　1，进入 <a target="_blank" rel="noopener" href="http://www.iconfont.cn/">阿里巴巴矢量图</a> 并搜索你想要的图标</p>
<p>　　2，下载 Icon 时使用 SVG 下载</p>
<p>　　3，用记事本或文本编辑器打开，标签 Path 下的 d 属性就是 Path 的 Data 数据（很多复杂一点的 Icon 可能是多个 Data 组成，使用时只要用空格把几个 Data 隔开就行）</p>
<p>　　例子：</p>
<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"\>

<p>　　&lt;svg t=“1491032725422” class=“icon” style=“” viewBox=“0 0 1024 1024” version=“1.1” xmlns=“<a target="_blank" rel="noopener" href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>“ p-id=“2372” xmlns:xlink=“<a target="_blank" rel="noopener" href="http://www.w3.org/1999/xlink">http://www.w3.org/1999/xlink</a>“ width=“248” height=“248”&gt;<br>　　&lt;defs&gt;<br>　　　　&lt;style type=“text&#x2F;css”&gt;&lt;&#x2F;style&gt;<br>　　&lt;&#x2F;defs&gt;<br>　　&lt;path d=“M503.2868 510.9903m-349.4226 0a341.233 341.233 0 1 0 698.8452 0 341.233 341.233 0 1 0-698.8452 0Z” p-id=“2373”&gt;&lt;&#x2F;path&gt;<br>　　&lt;path d=“M106.1386 263.9677a110 100 0 1 1 121.6696 248.2668Z” p-id=“2374”&gt;&lt;&#x2F;path&gt;<br>&lt;&#x2F;svg&gt;</p>
<p>　　在WPF中使用时：</p>
<p>&lt;Path Data=“M503.2868 510.9903m-349.4226 0a341.233 341.233 0 1 0 698.8452 0 341.233 341.233 0 1 0-698.8452 0Z M106.1386 263.9677a110 100 0 1 1 121.6696 248.2668Z”&#x2F;&gt;</p>
<p>Data 也可以作为资源放在独立的资源字典里，使用的 Geometry 标签</p>
<p>&lt;Geometry x:Key=“logo”&gt;M503.2868 510.9903m-349.4226 0a341.233 341.233 0 1 0 698.8452 0 341.233 341.233 0 1 0-698.8452 0Z M106.1386 263.9677a110 100 0 1 1 121.6696 248.2668Z&lt;&#x2F;Geometry&gt;</p>
<p>XAML：</p>
<p>&lt;Path Data=“{StaticResource logo}” Fill=“White” Stretch=“Fill” Stroke=“White” StrokeThickness=“1.5” &#x2F;&gt;</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/16/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/18/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2015 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Chemmy</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="giscus" type="application/json">{"enable":true,"repo":"chengming0916/chengming0916.github.io","repo_id":"R_kgDOLemcag","category":"Announcements","category_id":"DIC_kwDOLemcas4CupMn","mapping":"title","strict":0,"reactions_enabled":1,"emit_metadata":1,"theme":"light","lang":"zh-CN","crossorigin":"anonymous","input_position":"bottom","loading":"lazy"}</script>

<script>
document.addEventListener('page:loaded', () => {
  if (!CONFIG.page.comments) return;

  NexT.utils.loadComments('.giscus-container')
    .then(() => NexT.utils.getScript('https://giscus.app/client.js', {
      attributes: {
        async                   : true,
        crossOrigin             : 'anonymous',
        'data-repo'             : CONFIG.giscus.repo,
        'data-repo-id'          : CONFIG.giscus.repo_id,
        'data-category'         : CONFIG.giscus.category,
        'data-category-id'      : CONFIG.giscus.category_id,
        'data-mapping'          : CONFIG.giscus.mapping,
        'data-strict'           : CONFIG.giscus.strict,
        'data-reactions-enabled': CONFIG.giscus.reactions_enabled,
        'data-emit-metadata'    : CONFIG.giscus.emit_metadata,
        'data-theme'            : CONFIG.giscus.theme,
        'data-lang'             : CONFIG.giscus.lang,
        'data-input-position'   : CONFIG.giscus.input_position,
        'data-loading'          : CONFIG.giscus.loading
      },
      parentNode: document.querySelector('.giscus-container')
    }));
});
</script>

</body>
</html>
